"use strict";var threePlatformize=require("../../chunks/three-platformize.js");class Blob{constructor(parts,options){this.parts=parts;this.options=options}}var chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var lookup=new Uint8Array(256);for(var i=0;i<chars.length;i++){lookup[chars.charCodeAt(i)]=i}function encode(arrayBuffer){var base64="";var bytes=new Uint8Array(arrayBuffer);var byteLength=bytes.byteLength;var byteRemainder=byteLength%3;var mainLength=byteLength-byteRemainder;var a,b,c,d;var chunk;for(var i=0;i<mainLength;i=i+3){chunk=bytes[i]<<16|bytes[i+1]<<8|bytes[i+2];a=(chunk&16515072)>>18;b=(chunk&258048)>>12;c=(chunk&4032)>>6;d=chunk&63;base64+=chars[a]+chars[b]+chars[c]+chars[d]}if(byteRemainder==1){chunk=bytes[mainLength];a=(chunk&252)>>2;b=(chunk&3)<<4;base64+=chars[a]+chars[b]+"=="}else if(byteRemainder==2){chunk=bytes[mainLength]<<8|bytes[mainLength+1];a=(chunk&64512)>>10;b=(chunk&1008)>>4;c=(chunk&15)<<2;base64+=chars[a]+chars[b]+chars[c]+"="}return base64}class $URL{createObjectURL(obj){if(obj instanceof Blob){const base64=encode(obj.parts[0]);const url=`data:${obj.options.type};base64,${base64}`;return url}return""}revokeObjectURL(){}}function atob(data){data=`${data}`;data=data.replace(/[ \t\n\f\r]/g,"");if(data.length%4===0){data=data.replace(/==?$/,"")}if(data.length%4===1||/[^+/0-9A-Za-z]/.test(data)){return null}let output="";let buffer=0;let accumulatedBits=0;for(let i=0;i<data.length;i++){buffer<<=6;buffer|=atobLookup(data[i]);accumulatedBits+=6;if(accumulatedBits===24){output+=String.fromCharCode((buffer&16711680)>>16);output+=String.fromCharCode((buffer&65280)>>8);output+=String.fromCharCode(buffer&255);buffer=accumulatedBits=0}}if(accumulatedBits===12){buffer>>=4;output+=String.fromCharCode(buffer)}else if(accumulatedBits===18){buffer>>=2;output+=String.fromCharCode((buffer&65280)>>8);output+=String.fromCharCode(buffer&255)}return output}const keystr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";function atobLookup(chr){const index=keystr.indexOf(chr);return index<0?undefined:index}const _events=new WeakMap;class Touch{constructor(touch){this.identifier=touch.identifier;this.force=touch.force===undefined?1:touch.force;this.pageX=touch.pageX===undefined?touch.x:touch.pageX;this.pageY=touch.pageY===undefined?touch.y:touch.pageY;this.clientX=touch.clientX===undefined?touch.x:touch.clientX;this.clientY=touch.clientY===undefined?touch.y:touch.clientY;this.screenX=this.pageX;this.screenY=this.pageY}}class EventTarget{constructor(){_events.set(this,{})}addEventListener(type,listener,options={}){let events=_events.get(this);if(!events){events={};_events.set(this,events)}if(!events[type]){events[type]=[]}events[type].push(listener);if(options.capture);if(options.once);if(options.passive);}removeEventListener(type,listener){const events=_events.get(this);if(events){const listeners=events[type];if(listeners&&listeners.length>0){for(let i=listeners.length;i--;i>0){if(listeners[i]===listener){listeners.splice(i,1);break}}}}}dispatchEvent(event={}){if(typeof event.preventDefault!=="function"){event.preventDefault=()=>{}}if(typeof event.stopPropagation!=="function"){event.stopPropagation=()=>{}}const events=_events.get(this);if(events){const listeners=events[event.type];if(listeners){for(let i=0;i<listeners.length;i++){listeners[i](event)}}}}}const _requestHeader=new WeakMap;const _responseHeader=new WeakMap;const _requestTask=new WeakMap;function _triggerEvent(type,event={}){event.target=event.target||this;if(typeof this[`on${type}`]==="function"){this[`on${type}`].call(this,event)}}function _changeReadyState(readyState,event={}){this.readyState=readyState;event.readyState=readyState;_triggerEvent.call(this,"readystatechange",event)}function _isRelativePath(url){return!/^(http|https|ftp|wxfile):\/\/.*/i.test(url)}class $XMLHttpRequest extends EventTarget{constructor(){super();this.onabort=null;this.onerror=null;this.onload=null;this.onloadstart=null;this.onprogress=null;this.ontimeout=null;this.onloadend=null;this.onreadystatechange=null;this.readyState=0;this.response=null;this.responseText=null;this.responseType="text";this.dataType="string";this.responseXML=null;this.status=0;this.statusText="";this.upload={};this.withCredentials=false;_requestHeader.set(this,{"content-type":"application/x-www-form-urlencoded"});_responseHeader.set(this,{})}abort(){const myRequestTask=_requestTask.get(this);if(myRequestTask){myRequestTask.abort()}}getAllResponseHeaders(){const responseHeader=_responseHeader.get(this);return Object.keys(responseHeader).map((header=>`${header}: ${responseHeader[header]}`)).join("\n")}getResponseHeader(header){return _responseHeader.get(this)[header]}open(method,url){this._method=method;this._url=url;_changeReadyState.call(this,$XMLHttpRequest.OPENED)}overrideMimeType(){}send(data=""){if(this.readyState!==$XMLHttpRequest.OPENED){throw new Error("Failed to execute 'send' on 'XMLHttpRequest': The object's state must be OPENED.")}else{const url=this._url;const header=_requestHeader.get(this);const responseType=this.responseType;const dataType=this.dataType;const relative=_isRelativePath(url);let encoding;if(responseType==="arraybuffer");else{encoding="utf8"}delete this.response;this.response=null;let resolved=false;const onSuccess=({data:data,statusCode:statusCode,header:header})=>{if(resolved)return;resolved=true;statusCode=statusCode===undefined?200:statusCode;if(typeof data!=="string"&&!(data instanceof ArrayBuffer)){try{data=JSON.stringify(data)}catch(e){}}this.status=statusCode;if(header){_responseHeader.set(this,header)}_triggerEvent.call(this,"loadstart");_changeReadyState.call(this,$XMLHttpRequest.HEADERS_RECEIVED);_changeReadyState.call(this,$XMLHttpRequest.LOADING);this.response=data;if(data instanceof ArrayBuffer){Object.defineProperty(this,"responseText",{enumerable:true,configurable:true,get:function(){throw"InvalidStateError : responseType is "+this.responseType}})}else{this.responseText=data}_changeReadyState.call(this,$XMLHttpRequest.DONE);_triggerEvent.call(this,"load");_triggerEvent.call(this,"loadend")};const onFail=({errMsg:errMsg})=>{if(resolved)return;resolved=true;if(errMsg.indexOf("abort")!==-1){_triggerEvent.call(this,"abort")}else{_triggerEvent.call(this,"error",{message:errMsg})}_triggerEvent.call(this,"loadend");if(relative){console.warn(errMsg)}};if(relative){const fs=tt.getFileSystemManager();var options={filePath:url,success:onSuccess,fail:onFail};if(encoding){options["encoding"]=encoding}fs.readFile(options);return}tt.request({data:data,url:url,method:this._method,header:header,dataType:dataType,responseType:responseType,enableCache:false,success:onSuccess,fail:onFail})}}setRequestHeader(header,value){const myHeader=_requestHeader.get(this);myHeader[header]=value;_requestHeader.set(this,myHeader)}addEventListener(type,listener){if(typeof listener!=="function"){return}this["on"+type]=(event={})=>{event.target=event.target||this;listener.call(this,event)}}removeEventListener(type,listener){if(this["on"+type]===listener){this["on"+type]=null}}}$XMLHttpRequest.UNSEND=0;$XMLHttpRequest.OPENED=1;$XMLHttpRequest.HEADERS_RECEIVED=2;$XMLHttpRequest.LOADING=3;$XMLHttpRequest.DONE=4;function copyProperties(target,source){for(let key of Object.getOwnPropertyNames(source)){if(key!=="constructor"&&key!=="prototype"&&key!=="name"){let desc=Object.getOwnPropertyDescriptor(source,key);Object.defineProperty(target,key,desc)}}}function parse(xml){xml=xml.trim();xml=xml.replace(/<!--[\s\S]*?-->/g,"");return document();function document(){return{declaration:declaration(),root:tag()}}function declaration(){const m=match(/^<\?xml\s*/);if(!m)return;const node={attributes:{}};while(!(eos()||is("?>"))){const attr=attribute();if(!attr)return node;node.attributes[attr.name]=attr.value}match(/\?>\s*/);match(/<!DOCTYPE[^>]*>\s/);return node}function tag(){const m=match(/^<([\w-:.]+)\s*/);if(!m)return;const node={name:m[1],attributes:{},children:[]};while(!(eos()||is(">")||is("?>")||is("/>"))){const attr=attribute();if(!attr)return node;node.attributes[attr.name]=attr.value}if(match(/^\s*\/>\s*/)){return node}match(/\??>\s*/);node.content=content();let child;while(child=tag()){node.children.push(child)}match(/^<\/[\w-:.]+>\s*/);return node}function content(){const m=match(/^([^<]*)/);if(m)return m[1];return""}function attribute(){const m=match(/([\w:-]+)\s*=\s*("[^"]*"|'[^']*'|\w+)\s*/);if(!m)return;return{name:m[1],value:strip(m[2])}}function strip(val){return val.replace(/^['"]|['"]$/g,"")}function match(re){const m=xml.match(re);if(!m)return;xml=xml.slice(m[0].length);return m}function eos(){return xml.length==0}function is(prefix){return xml.indexOf(prefix)==0}}function walkTree(node,processer){processer(node);node.children.forEach((i=>walkTree(i,processer)))}class $DOMParser{parseFromString(str){const xml=parse(str);const nodeBase={hasAttribute(key){return this.attributes[key]!==undefined},getAttribute(key){return this.attributes[key]},getElementsByTagName(tag){const result=[];this.childNodes.forEach((i=>walkTree(i,(node=>tag===node.name&&result.push(node)))));return result}};walkTree(xml.root,(node=>{node.nodeType=1;node.nodeName=node.name;node.style=new Proxy((node.attributes.style||"").split(";").reduce(((acc,curr)=>{if(curr){let[key,value]=curr.split(":");acc[key.trim()]=value.trim()}return acc}),{}),{get(target,key){return target[key]||""}});node.textContent=node.content;node.childNodes=node.children;node.__proto__=nodeBase}));const out={documentElement:xml.root,childNodes:[xml.root]};out.__proto__=nodeBase;return out}}class $TextDecoder{decode(uint8Array){let s="";for(let i=0,il=uint8Array.length;i<il;i++)s+=String.fromCharCode(uint8Array[i]);try{return decodeURIComponent(escape(s))}catch(e){return s}}}function OffscreenCanvas(){return tt.createOffscreenCanvas()}class BytePlatform{constructor(canvas,width,height){const systemInfo=tt.getSystemInfoSync();const isAndroid=systemInfo.platform==="android";this.canvas=canvas;this.canvasW=width===undefined?canvas.width:width;this.canvasH=height===undefined?canvas.height:height;this.document={createElementNS(_,type){if(type==="canvas")return canvas;if(type==="img"){const img=canvas.createImage();img.addEventListener=(name,cb)=>img[`on${name}`]=cb.bind(img);img.removeEventListener=(name,cb)=>img[`on${name}`]=null;return img}}};this.window={innerWidth:systemInfo.windowWidth,innerHeight:systemInfo.windowHeight,devicePixelRatio:systemInfo.pixelRatio,URL:new $URL,AudioContext:function(){},requestAnimationFrame:this.canvas.requestAnimationFrame,cancelAnimationFrame:this.canvas.cancelAnimationFrame,DeviceOrientationEvent:{requestPermission(){return Promise.resolve("granted")}},DOMParser:$DOMParser,TextDecoder:$TextDecoder};[this.canvas,this.document,this.window].forEach((i=>{const old=i.__proto__;i.__proto__={};i.__proto__.__proto__=old;copyProperties(i.__proto__,EventTarget.prototype)}));this.patchCanvas()}patchCanvas(){const{canvasH:canvasH,canvasW:canvasW}=this;Object.defineProperty(this.canvas,"style",{get(){return{width:this.width+"px",height:this.height+"px"}}});Object.defineProperty(this.canvas,"clientHeight",{get(){return canvasH||this.height}});Object.defineProperty(this.canvas,"clientWidth",{get(){return canvasW||this.width}});this.canvas.ownerDocument=this.document}getGlobals(){return{atob:atob,Blob:Blob,window:this.window,document:this.document,HTMLCanvasElement:undefined,XMLHttpRequest:$XMLHttpRequest,OffscreenCanvas:OffscreenCanvas,createImageBitmap:undefined}}dispatchTouchEvent(e={}){const target={...this};const event={changedTouches:e.changedTouches.map((touch=>new Touch(touch))),touches:e.touches.map((touch=>new Touch(touch))),targetTouches:Array.prototype.slice.call(e.touches.map((touch=>new Touch(touch)))),timeStamp:e.timeStamp,target:target,currentTarget:target,type:e.type,cancelBubble:false,cancelable:false};this.canvas.dispatchEvent(event)}dispose(){this.canvas.width=0;this.canvas.height=0;if(this.canvas)this.canvas.ownerDocument=null;this.onDeviceMotionChange=null;this.document=null;this.window=null;this.canvas=null}}var GLTFLoader=function(){function GLTFLoader(manager){threePlatformize.Loader.call(this,manager);this.dracoLoader=null;this.ktx2Loader=null;this.meshoptDecoder=null;this.pluginCallbacks=[];this.register((function(parser){return new GLTFMaterialsClearcoatExtension(parser)}));this.register((function(parser){return new GLTFTextureBasisUExtension(parser)}));this.register((function(parser){return new GLTFTextureWebPExtension(parser)}));this.register((function(parser){return new GLTFMaterialsTransmissionExtension(parser)}));this.register((function(parser){return new GLTFLightsExtension(parser)}));this.register((function(parser){return new GLTFMeshoptCompression(parser)}))}GLTFLoader.prototype=Object.assign(Object.create(threePlatformize.Loader.prototype),{constructor:GLTFLoader,load:function(url,onLoad,onProgress,onError){var scope=this;var resourcePath;if(this.resourcePath!==""){resourcePath=this.resourcePath}else if(this.path!==""){resourcePath=this.path}else{resourcePath=threePlatformize.LoaderUtils.extractUrlBase(url)}this.manager.itemStart(url);var _onError=function(e){if(onError){onError(e)}else{console.error(e)}scope.manager.itemError(url);scope.manager.itemEnd(url)};var loader=new threePlatformize.FileLoader(this.manager);loader.setPath(this.path);loader.setResponseType("arraybuffer");loader.setRequestHeader(this.requestHeader);loader.setWithCredentials(this.withCredentials);loader.load(url,(function(data){try{scope.parse(data,resourcePath,(function(gltf){onLoad(gltf);scope.manager.itemEnd(url)}),_onError)}catch(e){_onError(e)}}),onProgress,_onError)},setDRACOLoader:function(dracoLoader){this.dracoLoader=dracoLoader;return this},setDDSLoader:function(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')},setKTX2Loader:function(ktx2Loader){this.ktx2Loader=ktx2Loader;return this},setMeshoptDecoder:function(meshoptDecoder){this.meshoptDecoder=meshoptDecoder;return this},register:function(callback){if(this.pluginCallbacks.indexOf(callback)===-1){this.pluginCallbacks.push(callback)}return this},unregister:function(callback){if(this.pluginCallbacks.indexOf(callback)!==-1){this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(callback),1)}return this},parse:function(data,path,onLoad,onError){var content;var extensions={};var plugins={};if(typeof data==="string"){content=data}else{var magic=threePlatformize.LoaderUtils.decodeText(new Uint8Array(data,0,4));if(magic===BINARY_EXTENSION_HEADER_MAGIC){try{extensions[EXTENSIONS.KHR_BINARY_GLTF]=new GLTFBinaryExtension(data)}catch(error){if(onError)onError(error);return}content=extensions[EXTENSIONS.KHR_BINARY_GLTF].content}else{content=threePlatformize.LoaderUtils.decodeText(new Uint8Array(data))}}var json=JSON.parse(content);if(json.asset===undefined||json.asset.version[0]<2){if(onError)onError(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}var parser=new GLTFParser(json,{path:path||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});parser.fileLoader.setRequestHeader(this.requestHeader);for(var i=0;i<this.pluginCallbacks.length;i++){var plugin=this.pluginCallbacks[i](parser);plugins[plugin.name]=plugin;extensions[plugin.name]=true}if(json.extensionsUsed){for(var i=0;i<json.extensionsUsed.length;++i){var extensionName=json.extensionsUsed[i];var extensionsRequired=json.extensionsRequired||[];switch(extensionName){case EXTENSIONS.KHR_MATERIALS_UNLIT:extensions[extensionName]=new GLTFMaterialsUnlitExtension;break;case EXTENSIONS.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:extensions[extensionName]=new GLTFMaterialsPbrSpecularGlossinessExtension;break;case EXTENSIONS.KHR_DRACO_MESH_COMPRESSION:extensions[extensionName]=new GLTFDracoMeshCompressionExtension(json,this.dracoLoader);break;case EXTENSIONS.KHR_TEXTURE_TRANSFORM:extensions[extensionName]=new GLTFTextureTransformExtension;break;case EXTENSIONS.KHR_MESH_QUANTIZATION:extensions[extensionName]=new GLTFMeshQuantizationExtension;break;default:if(extensionsRequired.indexOf(extensionName)>=0&&plugins[extensionName]===undefined){console.warn('THREE.GLTFLoader: Unknown extension "'+extensionName+'".')}}}}parser.setExtensions(extensions);parser.setPlugins(plugins);parser.parse(onLoad,onError)}});function GLTFRegistry(){var objects={};return{get:function(key){return objects[key]},add:function(key,object){objects[key]=object},remove:function(key){delete objects[key]},removeAll:function(){objects={}}}}var EXTENSIONS={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression"};function GLTFLightsExtension(parser){this.parser=parser;this.name=EXTENSIONS.KHR_LIGHTS_PUNCTUAL;this.cache={refs:{},uses:{}}}GLTFLightsExtension.prototype._markDefs=function(){var parser=this.parser;var nodeDefs=this.parser.json.nodes||[];for(var nodeIndex=0,nodeLength=nodeDefs.length;nodeIndex<nodeLength;nodeIndex++){var nodeDef=nodeDefs[nodeIndex];if(nodeDef.extensions&&nodeDef.extensions[this.name]&&nodeDef.extensions[this.name].light!==undefined){parser._addNodeRef(this.cache,nodeDef.extensions[this.name].light)}}};GLTFLightsExtension.prototype._loadLight=function(lightIndex){var parser=this.parser;var cacheKey="light:"+lightIndex;var dependency=parser.cache.get(cacheKey);if(dependency)return dependency;var json=parser.json;var extensions=json.extensions&&json.extensions[this.name]||{};var lightDefs=extensions.lights||[];var lightDef=lightDefs[lightIndex];var lightNode;var color=new threePlatformize.Color(16777215);if(lightDef.color!==undefined)color.fromArray(lightDef.color);var range=lightDef.range!==undefined?lightDef.range:0;switch(lightDef.type){case"directional":lightNode=new threePlatformize.DirectionalLight(color);lightNode.target.position.set(0,0,-1);lightNode.add(lightNode.target);break;case"point":lightNode=new threePlatformize.PointLight(color);lightNode.distance=range;break;case"spot":lightNode=new threePlatformize.SpotLight(color);lightNode.distance=range;lightDef.spot=lightDef.spot||{};lightDef.spot.innerConeAngle=lightDef.spot.innerConeAngle!==undefined?lightDef.spot.innerConeAngle:0;lightDef.spot.outerConeAngle=lightDef.spot.outerConeAngle!==undefined?lightDef.spot.outerConeAngle:Math.PI/4;lightNode.angle=lightDef.spot.outerConeAngle;lightNode.penumbra=1-lightDef.spot.innerConeAngle/lightDef.spot.outerConeAngle;lightNode.target.position.set(0,0,-1);lightNode.add(lightNode.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+lightDef.type)}lightNode.position.set(0,0,0);lightNode.decay=2;if(lightDef.intensity!==undefined)lightNode.intensity=lightDef.intensity;lightNode.name=parser.createUniqueName(lightDef.name||"light_"+lightIndex);dependency=Promise.resolve(lightNode);parser.cache.add(cacheKey,dependency);return dependency};GLTFLightsExtension.prototype.createNodeAttachment=function(nodeIndex){var self=this;var parser=this.parser;var json=parser.json;var nodeDef=json.nodes[nodeIndex];var lightDef=nodeDef.extensions&&nodeDef.extensions[this.name]||{};var lightIndex=lightDef.light;if(lightIndex===undefined)return null;return this._loadLight(lightIndex).then((function(light){return parser._getNodeRef(self.cache,lightIndex,light)}))};function GLTFMaterialsUnlitExtension(){this.name=EXTENSIONS.KHR_MATERIALS_UNLIT}GLTFMaterialsUnlitExtension.prototype.getMaterialType=function(){return threePlatformize.MeshBasicMaterial};GLTFMaterialsUnlitExtension.prototype.extendParams=function(materialParams,materialDef,parser){var pending=[];materialParams.color=new threePlatformize.Color(1,1,1);materialParams.opacity=1;var metallicRoughness=materialDef.pbrMetallicRoughness;if(metallicRoughness){if(Array.isArray(metallicRoughness.baseColorFactor)){var array=metallicRoughness.baseColorFactor;materialParams.color.fromArray(array);materialParams.opacity=array[3]}if(metallicRoughness.baseColorTexture!==undefined){pending.push(parser.assignTexture(materialParams,"map",metallicRoughness.baseColorTexture))}}return Promise.all(pending)};function GLTFMaterialsClearcoatExtension(parser){this.parser=parser;this.name=EXTENSIONS.KHR_MATERIALS_CLEARCOAT}GLTFMaterialsClearcoatExtension.prototype.getMaterialType=function(materialIndex){var parser=this.parser;var materialDef=parser.json.materials[materialIndex];if(!materialDef.extensions||!materialDef.extensions[this.name])return null;return threePlatformize.MeshPhysicalMaterial};GLTFMaterialsClearcoatExtension.prototype.extendMaterialParams=function(materialIndex,materialParams){var parser=this.parser;var materialDef=parser.json.materials[materialIndex];if(!materialDef.extensions||!materialDef.extensions[this.name]){return Promise.resolve()}var pending=[];var extension=materialDef.extensions[this.name];if(extension.clearcoatFactor!==undefined){materialParams.clearcoat=extension.clearcoatFactor}if(extension.clearcoatTexture!==undefined){pending.push(parser.assignTexture(materialParams,"clearcoatMap",extension.clearcoatTexture))}if(extension.clearcoatRoughnessFactor!==undefined){materialParams.clearcoatRoughness=extension.clearcoatRoughnessFactor}if(extension.clearcoatRoughnessTexture!==undefined){pending.push(parser.assignTexture(materialParams,"clearcoatRoughnessMap",extension.clearcoatRoughnessTexture))}if(extension.clearcoatNormalTexture!==undefined){pending.push(parser.assignTexture(materialParams,"clearcoatNormalMap",extension.clearcoatNormalTexture));if(extension.clearcoatNormalTexture.scale!==undefined){var scale=extension.clearcoatNormalTexture.scale;materialParams.clearcoatNormalScale=new threePlatformize.Vector2(scale,-scale)}}return Promise.all(pending)};function GLTFMaterialsTransmissionExtension(parser){this.parser=parser;this.name=EXTENSIONS.KHR_MATERIALS_TRANSMISSION}GLTFMaterialsTransmissionExtension.prototype.getMaterialType=function(materialIndex){var parser=this.parser;var materialDef=parser.json.materials[materialIndex];if(!materialDef.extensions||!materialDef.extensions[this.name])return null;return threePlatformize.MeshPhysicalMaterial};GLTFMaterialsTransmissionExtension.prototype.extendMaterialParams=function(materialIndex,materialParams){var parser=this.parser;var materialDef=parser.json.materials[materialIndex];if(!materialDef.extensions||!materialDef.extensions[this.name]){return Promise.resolve()}var pending=[];var extension=materialDef.extensions[this.name];if(extension.transmissionFactor!==undefined){materialParams.transmission=extension.transmissionFactor}if(extension.transmissionTexture!==undefined){pending.push(parser.assignTexture(materialParams,"transmissionMap",extension.transmissionTexture))}return Promise.all(pending)};function GLTFTextureBasisUExtension(parser){this.parser=parser;this.name=EXTENSIONS.KHR_TEXTURE_BASISU}GLTFTextureBasisUExtension.prototype.loadTexture=function(textureIndex){var parser=this.parser;var json=parser.json;var textureDef=json.textures[textureIndex];if(!textureDef.extensions||!textureDef.extensions[this.name]){return null}var extension=textureDef.extensions[this.name];var source=json.images[extension.source];var loader=parser.options.ktx2Loader;if(!loader){if(json.extensionsRequired&&json.extensionsRequired.indexOf(this.name)>=0){throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures")}else{return null}}return parser.loadTextureImage(textureIndex,source,loader)};function GLTFTextureWebPExtension(parser){this.parser=parser;this.name=EXTENSIONS.EXT_TEXTURE_WEBP;this.isSupported=null}GLTFTextureWebPExtension.prototype.loadTexture=function(textureIndex){var name=this.name;var parser=this.parser;var json=parser.json;var textureDef=json.textures[textureIndex];if(!textureDef.extensions||!textureDef.extensions[name]){return null}var extension=textureDef.extensions[name];var source=json.images[extension.source];var loader=parser.textureLoader;if(source.uri){var handler=parser.options.manager.getHandler(source.uri);if(handler!==null)loader=handler}return this.detectSupport().then((function(isSupported){if(isSupported)return parser.loadTextureImage(textureIndex,source,loader);if(json.extensionsRequired&&json.extensionsRequired.indexOf(name)>=0){throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.")}return parser.loadTexture(textureIndex)}))};GLTFTextureWebPExtension.prototype.detectSupport=function(){if(!this.isSupported){this.isSupported=new Promise((function(resolve){var image=new Image;image.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA";image.onload=image.onerror=function(){resolve(image.height===1)}}))}return this.isSupported};function GLTFMeshoptCompression(parser){this.name=EXTENSIONS.EXT_MESHOPT_COMPRESSION;this.parser=parser}GLTFMeshoptCompression.prototype.loadBufferView=function(index){var json=this.parser.json;var bufferView=json.bufferViews[index];if(bufferView.extensions&&bufferView.extensions[this.name]){var extensionDef=bufferView.extensions[this.name];var buffer=this.parser.getDependency("buffer",extensionDef.buffer);var decoder=this.parser.options.meshoptDecoder;if(!decoder||!decoder.supported){if(json.extensionsRequired&&json.extensionsRequired.indexOf(this.name)>=0){throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files")}else{return null}}return Promise.all([buffer,decoder.ready]).then((function(res){var byteOffset=extensionDef.byteOffset||0;var byteLength=extensionDef.byteLength||0;var count=extensionDef.count;var stride=extensionDef.byteStride;var result=new ArrayBuffer(count*stride);var source=new Uint8Array(res[0],byteOffset,byteLength);decoder.decodeGltfBuffer(new Uint8Array(result),count,stride,source,extensionDef.mode,extensionDef.filter);return result}))}else{return null}};var BINARY_EXTENSION_HEADER_MAGIC="glTF";var BINARY_EXTENSION_HEADER_LENGTH=12;var BINARY_EXTENSION_CHUNK_TYPES={JSON:1313821514,BIN:5130562};function GLTFBinaryExtension(data){this.name=EXTENSIONS.KHR_BINARY_GLTF;this.content=null;this.body=null;var headerView=new DataView(data,0,BINARY_EXTENSION_HEADER_LENGTH);this.header={magic:threePlatformize.LoaderUtils.decodeText(new Uint8Array(data.slice(0,4))),version:headerView.getUint32(4,true),length:headerView.getUint32(8,true)};if(this.header.magic!==BINARY_EXTENSION_HEADER_MAGIC){throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.")}else if(this.header.version<2){throw new Error("THREE.GLTFLoader: Legacy binary file detected.")}var chunkContentsLength=this.header.length-BINARY_EXTENSION_HEADER_LENGTH;var chunkView=new DataView(data,BINARY_EXTENSION_HEADER_LENGTH);var chunkIndex=0;while(chunkIndex<chunkContentsLength){var chunkLength=chunkView.getUint32(chunkIndex,true);chunkIndex+=4;var chunkType=chunkView.getUint32(chunkIndex,true);chunkIndex+=4;if(chunkType===BINARY_EXTENSION_CHUNK_TYPES.JSON){var contentArray=new Uint8Array(data,BINARY_EXTENSION_HEADER_LENGTH+chunkIndex,chunkLength);this.content=threePlatformize.LoaderUtils.decodeText(contentArray)}else if(chunkType===BINARY_EXTENSION_CHUNK_TYPES.BIN){var byteOffset=BINARY_EXTENSION_HEADER_LENGTH+chunkIndex;this.body=data.slice(byteOffset,byteOffset+chunkLength)}chunkIndex+=chunkLength}if(this.content===null){throw new Error("THREE.GLTFLoader: JSON content not found.")}}function GLTFDracoMeshCompressionExtension(json,dracoLoader){if(!dracoLoader){throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.")}this.name=EXTENSIONS.KHR_DRACO_MESH_COMPRESSION;this.json=json;this.dracoLoader=dracoLoader;this.dracoLoader.preload()}GLTFDracoMeshCompressionExtension.prototype.decodePrimitive=function(primitive,parser){var json=this.json;var dracoLoader=this.dracoLoader;var bufferViewIndex=primitive.extensions[this.name].bufferView;var gltfAttributeMap=primitive.extensions[this.name].attributes;var threeAttributeMap={};var attributeNormalizedMap={};var attributeTypeMap={};for(var attributeName in gltfAttributeMap){var threeAttributeName=ATTRIBUTES[attributeName]||attributeName.toLowerCase();threeAttributeMap[threeAttributeName]=gltfAttributeMap[attributeName]}for(attributeName in primitive.attributes){var threeAttributeName=ATTRIBUTES[attributeName]||attributeName.toLowerCase();if(gltfAttributeMap[attributeName]!==undefined){var accessorDef=json.accessors[primitive.attributes[attributeName]];var componentType=WEBGL_COMPONENT_TYPES[accessorDef.componentType];attributeTypeMap[threeAttributeName]=componentType;attributeNormalizedMap[threeAttributeName]=accessorDef.normalized===true}}return parser.getDependency("bufferView",bufferViewIndex).then((function(bufferView){return new Promise((function(resolve){dracoLoader.decodeDracoFile(bufferView,(function(geometry){for(var attributeName in geometry.attributes){var attribute=geometry.attributes[attributeName];var normalized=attributeNormalizedMap[attributeName];if(normalized!==undefined)attribute.normalized=normalized}resolve(geometry)}),threeAttributeMap,attributeTypeMap)}))}))};function GLTFTextureTransformExtension(){this.name=EXTENSIONS.KHR_TEXTURE_TRANSFORM}GLTFTextureTransformExtension.prototype.extendTexture=function(texture,transform){texture=texture.clone();if(transform.offset!==undefined){texture.offset.fromArray(transform.offset)}if(transform.rotation!==undefined){texture.rotation=transform.rotation}if(transform.scale!==undefined){texture.repeat.fromArray(transform.scale)}if(transform.texCoord!==undefined){console.warn('THREE.GLTFLoader: Custom UV sets in "'+this.name+'" extension not yet supported.')}texture.needsUpdate=true;return texture};function GLTFMeshStandardSGMaterial(params){threePlatformize.MeshStandardMaterial.call(this);this.isGLTFSpecularGlossinessMaterial=true;var specularMapParsFragmentChunk=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n");var glossinessMapParsFragmentChunk=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n");var specularMapFragmentChunk=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\ttexelSpecular = sRGBToLinear( texelSpecular );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n");var glossinessMapFragmentChunk=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n");var lightPhysicalFragmentChunk=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb * ( 1. - max( specularFactor.r, max( specularFactor.g, specularFactor.b ) ) );","vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );","float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );","material.specularRoughness = max( 1.0 - glossinessFactor, 0.0525 ); // 0.0525 corresponds to the base mip of a 256 cubemap.","material.specularRoughness += geometryRoughness;","material.specularRoughness = min( material.specularRoughness, 1.0 );","material.specularColor = specularFactor;"].join("\n");var uniforms={specular:{value:(new threePlatformize.Color).setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};this._extraUniforms=uniforms;this.onBeforeCompile=function(shader){for(var uniformName in uniforms){shader.uniforms[uniformName]=uniforms[uniformName]}shader.fragmentShader=shader.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",specularMapParsFragmentChunk).replace("#include <metalnessmap_pars_fragment>",glossinessMapParsFragmentChunk).replace("#include <roughnessmap_fragment>",specularMapFragmentChunk).replace("#include <metalnessmap_fragment>",glossinessMapFragmentChunk).replace("#include <lights_physical_fragment>",lightPhysicalFragmentChunk)};Object.defineProperties(this,{specular:{get:function(){return uniforms.specular.value},set:function(v){uniforms.specular.value=v}},specularMap:{get:function(){return uniforms.specularMap.value},set:function(v){uniforms.specularMap.value=v;if(v){this.defines.USE_SPECULARMAP=""}else{delete this.defines.USE_SPECULARMAP}}},glossiness:{get:function(){return uniforms.glossiness.value},set:function(v){uniforms.glossiness.value=v}},glossinessMap:{get:function(){return uniforms.glossinessMap.value},set:function(v){uniforms.glossinessMap.value=v;if(v){this.defines.USE_GLOSSINESSMAP="";this.defines.USE_UV=""}else{delete this.defines.USE_GLOSSINESSMAP;delete this.defines.USE_UV}}}});delete this.metalness;delete this.roughness;delete this.metalnessMap;delete this.roughnessMap;this.setValues(params)}GLTFMeshStandardSGMaterial.prototype=Object.create(threePlatformize.MeshStandardMaterial.prototype);GLTFMeshStandardSGMaterial.prototype.constructor=GLTFMeshStandardSGMaterial;GLTFMeshStandardSGMaterial.prototype.copy=function(source){threePlatformize.MeshStandardMaterial.prototype.copy.call(this,source);this.specularMap=source.specularMap;this.specular.copy(source.specular);this.glossinessMap=source.glossinessMap;this.glossiness=source.glossiness;delete this.metalness;delete this.roughness;delete this.metalnessMap;delete this.roughnessMap;return this};function GLTFMaterialsPbrSpecularGlossinessExtension(){return{name:EXTENSIONS.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,specularGlossinessParams:["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"],getMaterialType:function(){return GLTFMeshStandardSGMaterial},extendParams:function(materialParams,materialDef,parser){var pbrSpecularGlossiness=materialDef.extensions[this.name];materialParams.color=new threePlatformize.Color(1,1,1);materialParams.opacity=1;var pending=[];if(Array.isArray(pbrSpecularGlossiness.diffuseFactor)){var array=pbrSpecularGlossiness.diffuseFactor;materialParams.color.fromArray(array);materialParams.opacity=array[3]}if(pbrSpecularGlossiness.diffuseTexture!==undefined){pending.push(parser.assignTexture(materialParams,"map",pbrSpecularGlossiness.diffuseTexture))}materialParams.emissive=new threePlatformize.Color(0,0,0);materialParams.glossiness=pbrSpecularGlossiness.glossinessFactor!==undefined?pbrSpecularGlossiness.glossinessFactor:1;materialParams.specular=new threePlatformize.Color(1,1,1);if(Array.isArray(pbrSpecularGlossiness.specularFactor)){materialParams.specular.fromArray(pbrSpecularGlossiness.specularFactor)}if(pbrSpecularGlossiness.specularGlossinessTexture!==undefined){var specGlossMapDef=pbrSpecularGlossiness.specularGlossinessTexture;pending.push(parser.assignTexture(materialParams,"glossinessMap",specGlossMapDef));pending.push(parser.assignTexture(materialParams,"specularMap",specGlossMapDef))}return Promise.all(pending)},createMaterial:function(materialParams){var material=new GLTFMeshStandardSGMaterial(materialParams);material.fog=true;material.color=materialParams.color;material.map=materialParams.map===undefined?null:materialParams.map;material.lightMap=null;material.lightMapIntensity=1;material.aoMap=materialParams.aoMap===undefined?null:materialParams.aoMap;material.aoMapIntensity=1;material.emissive=materialParams.emissive;material.emissiveIntensity=1;material.emissiveMap=materialParams.emissiveMap===undefined?null:materialParams.emissiveMap;material.bumpMap=materialParams.bumpMap===undefined?null:materialParams.bumpMap;material.bumpScale=1;material.normalMap=materialParams.normalMap===undefined?null:materialParams.normalMap;material.normalMapType=threePlatformize.TangentSpaceNormalMap;if(materialParams.normalScale)material.normalScale=materialParams.normalScale;material.displacementMap=null;material.displacementScale=1;material.displacementBias=0;material.specularMap=materialParams.specularMap===undefined?null:materialParams.specularMap;material.specular=materialParams.specular;material.glossinessMap=materialParams.glossinessMap===undefined?null:materialParams.glossinessMap;material.glossiness=materialParams.glossiness;material.alphaMap=null;material.envMap=materialParams.envMap===undefined?null:materialParams.envMap;material.envMapIntensity=1;material.refractionRatio=.98;return material}}}function GLTFMeshQuantizationExtension(){this.name=EXTENSIONS.KHR_MESH_QUANTIZATION}function GLTFCubicSplineInterpolant(parameterPositions,sampleValues,sampleSize,resultBuffer){threePlatformize.Interpolant.call(this,parameterPositions,sampleValues,sampleSize,resultBuffer)}GLTFCubicSplineInterpolant.prototype=Object.create(threePlatformize.Interpolant.prototype);GLTFCubicSplineInterpolant.prototype.constructor=GLTFCubicSplineInterpolant;GLTFCubicSplineInterpolant.prototype.copySampleValue_=function(index){var result=this.resultBuffer,values=this.sampleValues,valueSize=this.valueSize,offset=index*valueSize*3+valueSize;for(var i=0;i!==valueSize;i++){result[i]=values[offset+i]}return result};GLTFCubicSplineInterpolant.prototype.beforeStart_=GLTFCubicSplineInterpolant.prototype.copySampleValue_;GLTFCubicSplineInterpolant.prototype.afterEnd_=GLTFCubicSplineInterpolant.prototype.copySampleValue_;GLTFCubicSplineInterpolant.prototype.interpolate_=function(i1,t0,t,t1){var result=this.resultBuffer;var values=this.sampleValues;var stride=this.valueSize;var stride2=stride*2;var stride3=stride*3;var td=t1-t0;var p=(t-t0)/td;var pp=p*p;var ppp=pp*p;var offset1=i1*stride3;var offset0=offset1-stride3;var s2=-2*ppp+3*pp;var s3=ppp-pp;var s0=1-s2;var s1=s3-pp+p;for(var i=0;i!==stride;i++){var p0=values[offset0+i+stride];var m0=values[offset0+i+stride2]*td;var p1=values[offset1+i+stride];var m1=values[offset1+i]*td;result[i]=s0*p0+s1*m0+s2*p1+s3*m1}return result};var WEBGL_CONSTANTS={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123};var WEBGL_COMPONENT_TYPES={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};var WEBGL_FILTERS={9728:threePlatformize.NearestFilter,9729:threePlatformize.LinearFilter,9984:threePlatformize.NearestMipmapNearestFilter,9985:threePlatformize.LinearMipmapNearestFilter,9986:threePlatformize.NearestMipmapLinearFilter,9987:threePlatformize.LinearMipmapLinearFilter};var WEBGL_WRAPPINGS={33071:threePlatformize.ClampToEdgeWrapping,33648:threePlatformize.MirroredRepeatWrapping,10497:threePlatformize.RepeatWrapping};var WEBGL_TYPE_SIZES={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};var ATTRIBUTES={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"};var PATH_PROPERTIES={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"};var INTERPOLATION={CUBICSPLINE:undefined,LINEAR:threePlatformize.InterpolateLinear,STEP:threePlatformize.InterpolateDiscrete};var ALPHA_MODES={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function resolveURL(url,path){if(typeof url!=="string"||url==="")return"";if(/^https?:\/\//i.test(path)&&/^\//.test(url)){path=path.replace(/(^https?:\/\/[^\/]+).*/i,"$1")}if(/^(https?:)?\/\//i.test(url))return url;if(/^data:.*,.*$/i.test(url))return url;if(/^blob:.*$/i.test(url))return url;return path+url}function createDefaultMaterial(cache){if(cache["DefaultMaterial"]===undefined){cache["DefaultMaterial"]=new threePlatformize.MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:false,depthTest:true,side:threePlatformize.FrontSide})}return cache["DefaultMaterial"]}function addUnknownExtensionsToUserData(knownExtensions,object,objectDef){for(var name in objectDef.extensions){if(knownExtensions[name]===undefined){object.userData.gltfExtensions=object.userData.gltfExtensions||{};object.userData.gltfExtensions[name]=objectDef.extensions[name]}}}function assignExtrasToUserData(object,gltfDef){if(gltfDef.extras!==undefined){if(typeof gltfDef.extras==="object"){Object.assign(object.userData,gltfDef.extras)}else{console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+gltfDef.extras)}}}function addMorphTargets(geometry,targets,parser){var hasMorphPosition=false;var hasMorphNormal=false;for(var i=0,il=targets.length;i<il;i++){var target=targets[i];if(target.POSITION!==undefined)hasMorphPosition=true;if(target.NORMAL!==undefined)hasMorphNormal=true;if(hasMorphPosition&&hasMorphNormal)break}if(!hasMorphPosition&&!hasMorphNormal)return Promise.resolve(geometry);var pendingPositionAccessors=[];var pendingNormalAccessors=[];for(var i=0,il=targets.length;i<il;i++){var target=targets[i];if(hasMorphPosition){var pendingAccessor=target.POSITION!==undefined?parser.getDependency("accessor",target.POSITION):geometry.attributes.position;pendingPositionAccessors.push(pendingAccessor)}if(hasMorphNormal){var pendingAccessor=target.NORMAL!==undefined?parser.getDependency("accessor",target.NORMAL):geometry.attributes.normal;pendingNormalAccessors.push(pendingAccessor)}}return Promise.all([Promise.all(pendingPositionAccessors),Promise.all(pendingNormalAccessors)]).then((function(accessors){var morphPositions=accessors[0];var morphNormals=accessors[1];if(hasMorphPosition)geometry.morphAttributes.position=morphPositions;if(hasMorphNormal)geometry.morphAttributes.normal=morphNormals;geometry.morphTargetsRelative=true;return geometry}))}function updateMorphTargets(mesh,meshDef){mesh.updateMorphTargets();if(meshDef.weights!==undefined){for(var i=0,il=meshDef.weights.length;i<il;i++){mesh.morphTargetInfluences[i]=meshDef.weights[i]}}if(meshDef.extras&&Array.isArray(meshDef.extras.targetNames)){var targetNames=meshDef.extras.targetNames;if(mesh.morphTargetInfluences.length===targetNames.length){mesh.morphTargetDictionary={};for(var i=0,il=targetNames.length;i<il;i++){mesh.morphTargetDictionary[targetNames[i]]=i}}else{console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}}function createPrimitiveKey(primitiveDef){var dracoExtension=primitiveDef.extensions&&primitiveDef.extensions[EXTENSIONS.KHR_DRACO_MESH_COMPRESSION];var geometryKey;if(dracoExtension){geometryKey="draco:"+dracoExtension.bufferView+":"+dracoExtension.indices+":"+createAttributesKey(dracoExtension.attributes)}else{geometryKey=primitiveDef.indices+":"+createAttributesKey(primitiveDef.attributes)+":"+primitiveDef.mode}return geometryKey}function createAttributesKey(attributes){var attributesKey="";var keys=Object.keys(attributes).sort();for(var i=0,il=keys.length;i<il;i++){attributesKey+=keys[i]+":"+attributes[keys[i]]+";"}return attributesKey}function GLTFParser(json,options){this.json=json||{};this.extensions={};this.plugins={};this.options=options||{};this.cache=new GLTFRegistry;this.associations=new Map;this.primitiveCache={};this.meshCache={refs:{},uses:{}};this.cameraCache={refs:{},uses:{}};this.lightCache={refs:{},uses:{}};this.nodeNamesUsed={};if(typeof threePlatformize.$createImageBitmap!=="undefined"&&/Firefox/.test(navigator.userAgent)===false){this.textureLoader=new threePlatformize.ImageBitmapLoader(this.options.manager)}else{this.textureLoader=new threePlatformize.TextureLoader(this.options.manager)}this.textureLoader.setCrossOrigin(this.options.crossOrigin);this.textureLoader.setRequestHeader(this.options.requestHeader);this.fileLoader=new threePlatformize.FileLoader(this.options.manager);this.fileLoader.setResponseType("arraybuffer");if(this.options.crossOrigin==="use-credentials"){this.fileLoader.setWithCredentials(true)}}GLTFParser.prototype.setExtensions=function(extensions){this.extensions=extensions};GLTFParser.prototype.setPlugins=function(plugins){this.plugins=plugins};GLTFParser.prototype.parse=function(onLoad,onError){var parser=this;var json=this.json;var extensions=this.extensions;this.cache.removeAll();this._invokeAll((function(ext){return ext._markDefs&&ext._markDefs()}));Promise.all(this._invokeAll((function(ext){return ext.beforeRoot&&ext.beforeRoot()}))).then((function(){return Promise.all([parser.getDependencies("scene"),parser.getDependencies("animation"),parser.getDependencies("camera")])})).then((function(dependencies){var result={scene:dependencies[0][json.scene||0],scenes:dependencies[0],animations:dependencies[1],cameras:dependencies[2],asset:json.asset,parser:parser,userData:{}};addUnknownExtensionsToUserData(extensions,result,json);assignExtrasToUserData(result,json);Promise.all(parser._invokeAll((function(ext){return ext.afterRoot&&ext.afterRoot(result)}))).then((function(){onLoad(result)}))})).catch(onError)};GLTFParser.prototype._markDefs=function(){var nodeDefs=this.json.nodes||[];var skinDefs=this.json.skins||[];var meshDefs=this.json.meshes||[];for(var skinIndex=0,skinLength=skinDefs.length;skinIndex<skinLength;skinIndex++){var joints=skinDefs[skinIndex].joints;for(var i=0,il=joints.length;i<il;i++){nodeDefs[joints[i]].isBone=true}}for(var nodeIndex=0,nodeLength=nodeDefs.length;nodeIndex<nodeLength;nodeIndex++){var nodeDef=nodeDefs[nodeIndex];if(nodeDef.mesh!==undefined){this._addNodeRef(this.meshCache,nodeDef.mesh);if(nodeDef.skin!==undefined){meshDefs[nodeDef.mesh].isSkinnedMesh=true}}if(nodeDef.camera!==undefined){this._addNodeRef(this.cameraCache,nodeDef.camera)}}};GLTFParser.prototype._addNodeRef=function(cache,index){if(index===undefined)return;if(cache.refs[index]===undefined){cache.refs[index]=cache.uses[index]=0}cache.refs[index]++};GLTFParser.prototype._getNodeRef=function(cache,index,object){if(cache.refs[index]<=1)return object;var ref=object.clone();ref.name+="_instance_"+cache.uses[index]++;return ref};GLTFParser.prototype._invokeOne=function(func){var extensions=Object.values(this.plugins);extensions.push(this);for(var i=0;i<extensions.length;i++){var result=func(extensions[i]);if(result)return result}};GLTFParser.prototype._invokeAll=function(func){var extensions=Object.values(this.plugins);extensions.unshift(this);var pending=[];for(var i=0;i<extensions.length;i++){var result=func(extensions[i]);if(result)pending.push(result)}return pending};GLTFParser.prototype.getDependency=function(type,index){var cacheKey=type+":"+index;var dependency=this.cache.get(cacheKey);if(!dependency){switch(type){case"scene":dependency=this.loadScene(index);break;case"node":dependency=this.loadNode(index);break;case"mesh":dependency=this._invokeOne((function(ext){return ext.loadMesh&&ext.loadMesh(index)}));break;case"accessor":dependency=this.loadAccessor(index);break;case"bufferView":dependency=this._invokeOne((function(ext){return ext.loadBufferView&&ext.loadBufferView(index)}));break;case"buffer":dependency=this.loadBuffer(index);break;case"material":dependency=this._invokeOne((function(ext){return ext.loadMaterial&&ext.loadMaterial(index)}));break;case"texture":dependency=this._invokeOne((function(ext){return ext.loadTexture&&ext.loadTexture(index)}));break;case"skin":dependency=this.loadSkin(index);break;case"animation":dependency=this.loadAnimation(index);break;case"camera":dependency=this.loadCamera(index);break;default:throw new Error("Unknown type: "+type)}this.cache.add(cacheKey,dependency)}return dependency};GLTFParser.prototype.getDependencies=function(type){var dependencies=this.cache.get(type);if(!dependencies){var parser=this;var defs=this.json[type+(type==="mesh"?"es":"s")]||[];dependencies=Promise.all(defs.map((function(def,index){return parser.getDependency(type,index)})));this.cache.add(type,dependencies)}return dependencies};GLTFParser.prototype.loadBuffer=function(bufferIndex){var bufferDef=this.json.buffers[bufferIndex];var loader=this.fileLoader;if(bufferDef.type&&bufferDef.type!=="arraybuffer"){throw new Error("THREE.GLTFLoader: "+bufferDef.type+" buffer type is not supported.")}if(bufferDef.uri===undefined&&bufferIndex===0){return Promise.resolve(this.extensions[EXTENSIONS.KHR_BINARY_GLTF].body)}var options=this.options;return new Promise((function(resolve,reject){loader.load(resolveURL(bufferDef.uri,options.path),resolve,undefined,(function(){reject(new Error('THREE.GLTFLoader: Failed to load buffer "'+bufferDef.uri+'".'))}))}))};GLTFParser.prototype.loadBufferView=function(bufferViewIndex){var bufferViewDef=this.json.bufferViews[bufferViewIndex];return this.getDependency("buffer",bufferViewDef.buffer).then((function(buffer){var byteLength=bufferViewDef.byteLength||0;var byteOffset=bufferViewDef.byteOffset||0;return buffer.slice(byteOffset,byteOffset+byteLength)}))};GLTFParser.prototype.loadAccessor=function(accessorIndex){var parser=this;var json=this.json;var accessorDef=this.json.accessors[accessorIndex];if(accessorDef.bufferView===undefined&&accessorDef.sparse===undefined){return Promise.resolve(null)}var pendingBufferViews=[];if(accessorDef.bufferView!==undefined){pendingBufferViews.push(this.getDependency("bufferView",accessorDef.bufferView))}else{pendingBufferViews.push(null)}if(accessorDef.sparse!==undefined){pendingBufferViews.push(this.getDependency("bufferView",accessorDef.sparse.indices.bufferView));pendingBufferViews.push(this.getDependency("bufferView",accessorDef.sparse.values.bufferView))}return Promise.all(pendingBufferViews).then((function(bufferViews){var bufferView=bufferViews[0];var itemSize=WEBGL_TYPE_SIZES[accessorDef.type];var TypedArray=WEBGL_COMPONENT_TYPES[accessorDef.componentType];var elementBytes=TypedArray.BYTES_PER_ELEMENT;var itemBytes=elementBytes*itemSize;var byteOffset=accessorDef.byteOffset||0;var byteStride=accessorDef.bufferView!==undefined?json.bufferViews[accessorDef.bufferView].byteStride:undefined;var normalized=accessorDef.normalized===true;var array,bufferAttribute;if(byteStride&&byteStride!==itemBytes){var ibSlice=Math.floor(byteOffset/byteStride);var ibCacheKey="InterleavedBuffer:"+accessorDef.bufferView+":"+accessorDef.componentType+":"+ibSlice+":"+accessorDef.count;var ib=parser.cache.get(ibCacheKey);if(!ib){array=new TypedArray(bufferView,ibSlice*byteStride,accessorDef.count*byteStride/elementBytes);ib=new threePlatformize.InterleavedBuffer(array,byteStride/elementBytes);parser.cache.add(ibCacheKey,ib)}bufferAttribute=new threePlatformize.InterleavedBufferAttribute(ib,itemSize,byteOffset%byteStride/elementBytes,normalized)}else{if(bufferView===null){array=new TypedArray(accessorDef.count*itemSize)}else{array=new TypedArray(bufferView,byteOffset,accessorDef.count*itemSize)}bufferAttribute=new threePlatformize.BufferAttribute(array,itemSize,normalized)}if(accessorDef.sparse!==undefined){var itemSizeIndices=WEBGL_TYPE_SIZES.SCALAR;var TypedArrayIndices=WEBGL_COMPONENT_TYPES[accessorDef.sparse.indices.componentType];var byteOffsetIndices=accessorDef.sparse.indices.byteOffset||0;var byteOffsetValues=accessorDef.sparse.values.byteOffset||0;var sparseIndices=new TypedArrayIndices(bufferViews[1],byteOffsetIndices,accessorDef.sparse.count*itemSizeIndices);var sparseValues=new TypedArray(bufferViews[2],byteOffsetValues,accessorDef.sparse.count*itemSize);if(bufferView!==null){bufferAttribute=new threePlatformize.BufferAttribute(bufferAttribute.array.slice(),bufferAttribute.itemSize,bufferAttribute.normalized)}for(var i=0,il=sparseIndices.length;i<il;i++){var index=sparseIndices[i];bufferAttribute.setX(index,sparseValues[i*itemSize]);if(itemSize>=2)bufferAttribute.setY(index,sparseValues[i*itemSize+1]);if(itemSize>=3)bufferAttribute.setZ(index,sparseValues[i*itemSize+2]);if(itemSize>=4)bufferAttribute.setW(index,sparseValues[i*itemSize+3]);if(itemSize>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return bufferAttribute}))};GLTFParser.prototype.loadTexture=function(textureIndex){var json=this.json;var options=this.options;var textureDef=json.textures[textureIndex];var source=json.images[textureDef.source];var loader=this.textureLoader;if(source.uri){var handler=options.manager.getHandler(source.uri);if(handler!==null)loader=handler}return this.loadTextureImage(textureIndex,source,loader)};GLTFParser.prototype.loadTextureImage=function(textureIndex,source,loader){var parser=this;var json=this.json;var options=this.options;var textureDef=json.textures[textureIndex];var URL=threePlatformize.$URL||self.webkitURL;var sourceURI=source.uri;var isObjectURL=false;var hasAlpha=true;if(source.mimeType==="image/jpeg")hasAlpha=false;if(source.bufferView!==undefined){sourceURI=parser.getDependency("bufferView",source.bufferView).then((function(bufferView){if(source.mimeType==="image/png"){var colorType=new DataView(bufferView,25,1).getUint8(0,false);hasAlpha=colorType===6||colorType===4||colorType===3}isObjectURL=true;var blob=new threePlatformize.$Blob([bufferView],{type:source.mimeType});sourceURI=URL.createObjectURL(blob);return sourceURI}))}else if(source.uri===undefined){throw new Error("THREE.GLTFLoader: Image "+textureIndex+" is missing URI and bufferView")}return Promise.resolve(sourceURI).then((function(sourceURI){return new Promise((function(resolve,reject){var onLoad=resolve;if(loader.isImageBitmapLoader===true){onLoad=function(imageBitmap){resolve(new threePlatformize.CanvasTexture(imageBitmap))}}loader.load(resolveURL(sourceURI,options.path),onLoad,undefined,reject)}))})).then((function(texture){if(isObjectURL===true){URL.revokeObjectURL(sourceURI)}texture.flipY=false;if(textureDef.name)texture.name=textureDef.name;if(!hasAlpha)texture.format=threePlatformize.RGBFormat;var samplers=json.samplers||{};var sampler=samplers[textureDef.sampler]||{};texture.magFilter=WEBGL_FILTERS[sampler.magFilter]||threePlatformize.LinearFilter;texture.minFilter=WEBGL_FILTERS[sampler.minFilter]||threePlatformize.LinearMipmapLinearFilter;texture.wrapS=WEBGL_WRAPPINGS[sampler.wrapS]||threePlatformize.RepeatWrapping;texture.wrapT=WEBGL_WRAPPINGS[sampler.wrapT]||threePlatformize.RepeatWrapping;parser.associations.set(texture,{type:"textures",index:textureIndex});return texture}))};GLTFParser.prototype.assignTexture=function(materialParams,mapName,mapDef){var parser=this;return this.getDependency("texture",mapDef.index).then((function(texture){if(mapDef.texCoord!==undefined&&mapDef.texCoord!=0&&!(mapName==="aoMap"&&mapDef.texCoord==1)){console.warn("THREE.GLTFLoader: Custom UV set "+mapDef.texCoord+" for texture "+mapName+" not yet supported.")}if(parser.extensions[EXTENSIONS.KHR_TEXTURE_TRANSFORM]){var transform=mapDef.extensions!==undefined?mapDef.extensions[EXTENSIONS.KHR_TEXTURE_TRANSFORM]:undefined;if(transform){var gltfReference=parser.associations.get(texture);texture=parser.extensions[EXTENSIONS.KHR_TEXTURE_TRANSFORM].extendTexture(texture,transform);parser.associations.set(texture,gltfReference)}}materialParams[mapName]=texture}))};GLTFParser.prototype.assignFinalMaterial=function(mesh){var geometry=mesh.geometry;var material=mesh.material;var useVertexTangents=geometry.attributes.tangent!==undefined;var useVertexColors=geometry.attributes.color!==undefined;var useFlatShading=geometry.attributes.normal===undefined;var useSkinning=mesh.isSkinnedMesh===true;var useMorphTargets=Object.keys(geometry.morphAttributes).length>0;var useMorphNormals=useMorphTargets&&geometry.morphAttributes.normal!==undefined;if(mesh.isPoints){var cacheKey="PointsMaterial:"+material.uuid;var pointsMaterial=this.cache.get(cacheKey);if(!pointsMaterial){pointsMaterial=new threePlatformize.PointsMaterial;threePlatformize.Material.prototype.copy.call(pointsMaterial,material);pointsMaterial.color.copy(material.color);pointsMaterial.map=material.map;pointsMaterial.sizeAttenuation=false;this.cache.add(cacheKey,pointsMaterial)}material=pointsMaterial}else if(mesh.isLine){var cacheKey="LineBasicMaterial:"+material.uuid;var lineMaterial=this.cache.get(cacheKey);if(!lineMaterial){lineMaterial=new threePlatformize.LineBasicMaterial;threePlatformize.Material.prototype.copy.call(lineMaterial,material);lineMaterial.color.copy(material.color);this.cache.add(cacheKey,lineMaterial)}material=lineMaterial}if(useVertexTangents||useVertexColors||useFlatShading||useSkinning||useMorphTargets){var cacheKey="ClonedMaterial:"+material.uuid+":";if(material.isGLTFSpecularGlossinessMaterial)cacheKey+="specular-glossiness:";if(useSkinning)cacheKey+="skinning:";if(useVertexTangents)cacheKey+="vertex-tangents:";if(useVertexColors)cacheKey+="vertex-colors:";if(useFlatShading)cacheKey+="flat-shading:";if(useMorphTargets)cacheKey+="morph-targets:";if(useMorphNormals)cacheKey+="morph-normals:";var cachedMaterial=this.cache.get(cacheKey);if(!cachedMaterial){cachedMaterial=material.clone();if(useSkinning)cachedMaterial.skinning=true;if(useVertexColors)cachedMaterial.vertexColors=true;if(useFlatShading)cachedMaterial.flatShading=true;if(useMorphTargets)cachedMaterial.morphTargets=true;if(useMorphNormals)cachedMaterial.morphNormals=true;if(useVertexTangents){cachedMaterial.vertexTangents=true;if(cachedMaterial.normalScale)cachedMaterial.normalScale.y*=-1;if(cachedMaterial.clearcoatNormalScale)cachedMaterial.clearcoatNormalScale.y*=-1}this.cache.add(cacheKey,cachedMaterial);this.associations.set(cachedMaterial,this.associations.get(material))}material=cachedMaterial}if(material.aoMap&&geometry.attributes.uv2===undefined&&geometry.attributes.uv!==undefined){geometry.setAttribute("uv2",geometry.attributes.uv)}mesh.material=material};GLTFParser.prototype.getMaterialType=function(){return threePlatformize.MeshStandardMaterial};GLTFParser.prototype.loadMaterial=function(materialIndex){var parser=this;var json=this.json;var extensions=this.extensions;var materialDef=json.materials[materialIndex];var materialType;var materialParams={};var materialExtensions=materialDef.extensions||{};var pending=[];if(materialExtensions[EXTENSIONS.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){var sgExtension=extensions[EXTENSIONS.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];materialType=sgExtension.getMaterialType();pending.push(sgExtension.extendParams(materialParams,materialDef,parser))}else if(materialExtensions[EXTENSIONS.KHR_MATERIALS_UNLIT]){var kmuExtension=extensions[EXTENSIONS.KHR_MATERIALS_UNLIT];materialType=kmuExtension.getMaterialType();pending.push(kmuExtension.extendParams(materialParams,materialDef,parser))}else{var metallicRoughness=materialDef.pbrMetallicRoughness||{};materialParams.color=new threePlatformize.Color(1,1,1);materialParams.opacity=1;if(Array.isArray(metallicRoughness.baseColorFactor)){var array=metallicRoughness.baseColorFactor;materialParams.color.fromArray(array);materialParams.opacity=array[3]}if(metallicRoughness.baseColorTexture!==undefined){pending.push(parser.assignTexture(materialParams,"map",metallicRoughness.baseColorTexture))}materialParams.metalness=metallicRoughness.metallicFactor!==undefined?metallicRoughness.metallicFactor:1;materialParams.roughness=metallicRoughness.roughnessFactor!==undefined?metallicRoughness.roughnessFactor:1;if(metallicRoughness.metallicRoughnessTexture!==undefined){pending.push(parser.assignTexture(materialParams,"metalnessMap",metallicRoughness.metallicRoughnessTexture));pending.push(parser.assignTexture(materialParams,"roughnessMap",metallicRoughness.metallicRoughnessTexture))}materialType=this._invokeOne((function(ext){return ext.getMaterialType&&ext.getMaterialType(materialIndex)}));pending.push(Promise.all(this._invokeAll((function(ext){return ext.extendMaterialParams&&ext.extendMaterialParams(materialIndex,materialParams)}))))}if(materialDef.doubleSided===true){materialParams.side=threePlatformize.DoubleSide}var alphaMode=materialDef.alphaMode||ALPHA_MODES.OPAQUE;if(alphaMode===ALPHA_MODES.BLEND){materialParams.transparent=true;materialParams.depthWrite=false}else{materialParams.transparent=false;if(alphaMode===ALPHA_MODES.MASK){materialParams.alphaTest=materialDef.alphaCutoff!==undefined?materialDef.alphaCutoff:.5}}if(materialDef.normalTexture!==undefined&&materialType!==threePlatformize.MeshBasicMaterial){pending.push(parser.assignTexture(materialParams,"normalMap",materialDef.normalTexture));materialParams.normalScale=new threePlatformize.Vector2(1,-1);if(materialDef.normalTexture.scale!==undefined){materialParams.normalScale.set(materialDef.normalTexture.scale,-materialDef.normalTexture.scale)}}if(materialDef.occlusionTexture!==undefined&&materialType!==threePlatformize.MeshBasicMaterial){pending.push(parser.assignTexture(materialParams,"aoMap",materialDef.occlusionTexture));if(materialDef.occlusionTexture.strength!==undefined){materialParams.aoMapIntensity=materialDef.occlusionTexture.strength}}if(materialDef.emissiveFactor!==undefined&&materialType!==threePlatformize.MeshBasicMaterial){materialParams.emissive=(new threePlatformize.Color).fromArray(materialDef.emissiveFactor)}if(materialDef.emissiveTexture!==undefined&&materialType!==threePlatformize.MeshBasicMaterial){pending.push(parser.assignTexture(materialParams,"emissiveMap",materialDef.emissiveTexture))}return Promise.all(pending).then((function(){var material;if(materialType===GLTFMeshStandardSGMaterial){material=extensions[EXTENSIONS.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(materialParams)}else{material=new materialType(materialParams)}if(materialDef.name)material.name=materialDef.name;if(material.map)material.map.encoding=threePlatformize.sRGBEncoding;if(material.emissiveMap)material.emissiveMap.encoding=threePlatformize.sRGBEncoding;assignExtrasToUserData(material,materialDef);parser.associations.set(material,{type:"materials",index:materialIndex});if(materialDef.extensions)addUnknownExtensionsToUserData(extensions,material,materialDef);return material}))};GLTFParser.prototype.createUniqueName=function(originalName){var sanitizedName=threePlatformize.PropertyBinding.sanitizeNodeName(originalName||"");var name=sanitizedName;for(var i=1;this.nodeNamesUsed[name];++i){name=sanitizedName+"_"+i}this.nodeNamesUsed[name]=true;return name};function computeBounds(geometry,primitiveDef,parser){var attributes=primitiveDef.attributes;var box=new threePlatformize.Box3;if(attributes.POSITION!==undefined){var accessor=parser.json.accessors[attributes.POSITION];var min=accessor.min;var max=accessor.max;if(min!==undefined&&max!==undefined){box.set(new threePlatformize.Vector3(min[0],min[1],min[2]),new threePlatformize.Vector3(max[0],max[1],max[2]))}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else{return}var targets=primitiveDef.targets;if(targets!==undefined){var maxDisplacement=new threePlatformize.Vector3;var vector=new threePlatformize.Vector3;for(var i=0,il=targets.length;i<il;i++){var target=targets[i];if(target.POSITION!==undefined){var accessor=parser.json.accessors[target.POSITION];var min=accessor.min;var max=accessor.max;if(min!==undefined&&max!==undefined){vector.setX(Math.max(Math.abs(min[0]),Math.abs(max[0])));vector.setY(Math.max(Math.abs(min[1]),Math.abs(max[1])));vector.setZ(Math.max(Math.abs(min[2]),Math.abs(max[2])));maxDisplacement.max(vector)}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}}box.expandByVector(maxDisplacement)}geometry.boundingBox=box;var sphere=new threePlatformize.Sphere;box.getCenter(sphere.center);sphere.radius=box.min.distanceTo(box.max)/2;geometry.boundingSphere=sphere}function addPrimitiveAttributes(geometry,primitiveDef,parser){var attributes=primitiveDef.attributes;var pending=[];function assignAttributeAccessor(accessorIndex,attributeName){return parser.getDependency("accessor",accessorIndex).then((function(accessor){geometry.setAttribute(attributeName,accessor)}))}for(var gltfAttributeName in attributes){var threeAttributeName=ATTRIBUTES[gltfAttributeName]||gltfAttributeName.toLowerCase();if(threeAttributeName in geometry.attributes)continue;pending.push(assignAttributeAccessor(attributes[gltfAttributeName],threeAttributeName))}if(primitiveDef.indices!==undefined&&!geometry.index){var accessor=parser.getDependency("accessor",primitiveDef.indices).then((function(accessor){geometry.setIndex(accessor)}));pending.push(accessor)}assignExtrasToUserData(geometry,primitiveDef);computeBounds(geometry,primitiveDef,parser);return Promise.all(pending).then((function(){return primitiveDef.targets!==undefined?addMorphTargets(geometry,primitiveDef.targets,parser):geometry}))}function toTrianglesDrawMode(geometry,drawMode){var index=geometry.getIndex();if(index===null){var indices=[];var position=geometry.getAttribute("position");if(position!==undefined){for(var i=0;i<position.count;i++){indices.push(i)}geometry.setIndex(indices);index=geometry.getIndex()}else{console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Undefined position attribute. Processing not possible.");return geometry}}var numberOfTriangles=index.count-2;var newIndices=[];if(drawMode===threePlatformize.TriangleFanDrawMode){for(var i=1;i<=numberOfTriangles;i++){newIndices.push(index.getX(0));newIndices.push(index.getX(i));newIndices.push(index.getX(i+1))}}else{for(var i=0;i<numberOfTriangles;i++){if(i%2===0){newIndices.push(index.getX(i));newIndices.push(index.getX(i+1));newIndices.push(index.getX(i+2))}else{newIndices.push(index.getX(i+2));newIndices.push(index.getX(i+1));newIndices.push(index.getX(i))}}}if(newIndices.length/3!==numberOfTriangles){console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Unable to generate correct amount of triangles.")}var newGeometry=geometry.clone();newGeometry.setIndex(newIndices);return newGeometry}GLTFParser.prototype.loadGeometries=function(primitives){var parser=this;var extensions=this.extensions;var cache=this.primitiveCache;function createDracoPrimitive(primitive){return extensions[EXTENSIONS.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(primitive,parser).then((function(geometry){return addPrimitiveAttributes(geometry,primitive,parser)}))}var pending=[];for(var i=0,il=primitives.length;i<il;i++){var primitive=primitives[i];var cacheKey=createPrimitiveKey(primitive);var cached=cache[cacheKey];if(cached){pending.push(cached.promise)}else{var geometryPromise;if(primitive.extensions&&primitive.extensions[EXTENSIONS.KHR_DRACO_MESH_COMPRESSION]){geometryPromise=createDracoPrimitive(primitive)}else{geometryPromise=addPrimitiveAttributes(new threePlatformize.BufferGeometry,primitive,parser)}cache[cacheKey]={primitive:primitive,promise:geometryPromise};pending.push(geometryPromise)}}return Promise.all(pending)};GLTFParser.prototype.loadMesh=function(meshIndex){var parser=this;var json=this.json;var extensions=this.extensions;var meshDef=json.meshes[meshIndex];var primitives=meshDef.primitives;var pending=[];for(var i=0,il=primitives.length;i<il;i++){var material=primitives[i].material===undefined?createDefaultMaterial(this.cache):this.getDependency("material",primitives[i].material);pending.push(material)}pending.push(parser.loadGeometries(primitives));return Promise.all(pending).then((function(results){var materials=results.slice(0,results.length-1);var geometries=results[results.length-1];var meshes=[];for(var i=0,il=geometries.length;i<il;i++){var geometry=geometries[i];var primitive=primitives[i];var mesh;var material=materials[i];if(primitive.mode===WEBGL_CONSTANTS.TRIANGLES||primitive.mode===WEBGL_CONSTANTS.TRIANGLE_STRIP||primitive.mode===WEBGL_CONSTANTS.TRIANGLE_FAN||primitive.mode===undefined){mesh=meshDef.isSkinnedMesh===true?new threePlatformize.SkinnedMesh(geometry,material):new threePlatformize.Mesh(geometry,material);if(mesh.isSkinnedMesh===true&&!mesh.geometry.attributes.skinWeight.normalized){mesh.normalizeSkinWeights()}if(primitive.mode===WEBGL_CONSTANTS.TRIANGLE_STRIP){mesh.geometry=toTrianglesDrawMode(mesh.geometry,threePlatformize.TriangleStripDrawMode)}else if(primitive.mode===WEBGL_CONSTANTS.TRIANGLE_FAN){mesh.geometry=toTrianglesDrawMode(mesh.geometry,threePlatformize.TriangleFanDrawMode)}}else if(primitive.mode===WEBGL_CONSTANTS.LINES){mesh=new threePlatformize.LineSegments(geometry,material)}else if(primitive.mode===WEBGL_CONSTANTS.LINE_STRIP){mesh=new threePlatformize.Line(geometry,material)}else if(primitive.mode===WEBGL_CONSTANTS.LINE_LOOP){mesh=new threePlatformize.LineLoop(geometry,material)}else if(primitive.mode===WEBGL_CONSTANTS.POINTS){mesh=new threePlatformize.Points(geometry,material)}else{throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+primitive.mode)}if(Object.keys(mesh.geometry.morphAttributes).length>0){updateMorphTargets(mesh,meshDef)}mesh.name=parser.createUniqueName(meshDef.name||"mesh_"+meshIndex);assignExtrasToUserData(mesh,meshDef);if(primitive.extensions)addUnknownExtensionsToUserData(extensions,mesh,primitive);parser.assignFinalMaterial(mesh);meshes.push(mesh)}if(meshes.length===1){return meshes[0]}var group=new threePlatformize.Group;for(var i=0,il=meshes.length;i<il;i++){group.add(meshes[i])}return group}))};GLTFParser.prototype.loadCamera=function(cameraIndex){var camera;var cameraDef=this.json.cameras[cameraIndex];var params=cameraDef[cameraDef.type];if(!params){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}if(cameraDef.type==="perspective"){camera=new threePlatformize.PerspectiveCamera(threePlatformize.MathUtils.radToDeg(params.yfov),params.aspectRatio||1,params.znear||1,params.zfar||2e6)}else if(cameraDef.type==="orthographic"){camera=new threePlatformize.OrthographicCamera(-params.xmag,params.xmag,params.ymag,-params.ymag,params.znear,params.zfar)}if(cameraDef.name)camera.name=this.createUniqueName(cameraDef.name);assignExtrasToUserData(camera,cameraDef);return Promise.resolve(camera)};GLTFParser.prototype.loadSkin=function(skinIndex){var skinDef=this.json.skins[skinIndex];var skinEntry={joints:skinDef.joints};if(skinDef.inverseBindMatrices===undefined){return Promise.resolve(skinEntry)}return this.getDependency("accessor",skinDef.inverseBindMatrices).then((function(accessor){skinEntry.inverseBindMatrices=accessor;return skinEntry}))};GLTFParser.prototype.loadAnimation=function(animationIndex){var json=this.json;var animationDef=json.animations[animationIndex];var pendingNodes=[];var pendingInputAccessors=[];var pendingOutputAccessors=[];var pendingSamplers=[];var pendingTargets=[];for(var i=0,il=animationDef.channels.length;i<il;i++){var channel=animationDef.channels[i];var sampler=animationDef.samplers[channel.sampler];var target=channel.target;var name=target.node!==undefined?target.node:target.id;var input=animationDef.parameters!==undefined?animationDef.parameters[sampler.input]:sampler.input;var output=animationDef.parameters!==undefined?animationDef.parameters[sampler.output]:sampler.output;pendingNodes.push(this.getDependency("node",name));pendingInputAccessors.push(this.getDependency("accessor",input));pendingOutputAccessors.push(this.getDependency("accessor",output));pendingSamplers.push(sampler);pendingTargets.push(target)}return Promise.all([Promise.all(pendingNodes),Promise.all(pendingInputAccessors),Promise.all(pendingOutputAccessors),Promise.all(pendingSamplers),Promise.all(pendingTargets)]).then((function(dependencies){var nodes=dependencies[0];var inputAccessors=dependencies[1];var outputAccessors=dependencies[2];var samplers=dependencies[3];var targets=dependencies[4];var tracks=[];for(var i=0,il=nodes.length;i<il;i++){var node=nodes[i];var inputAccessor=inputAccessors[i];var outputAccessor=outputAccessors[i];var sampler=samplers[i];var target=targets[i];if(node===undefined)continue;node.updateMatrix();node.matrixAutoUpdate=true;var TypedKeyframeTrack;switch(PATH_PROPERTIES[target.path]){case PATH_PROPERTIES.weights:TypedKeyframeTrack=threePlatformize.NumberKeyframeTrack;break;case PATH_PROPERTIES.rotation:TypedKeyframeTrack=threePlatformize.QuaternionKeyframeTrack;break;case PATH_PROPERTIES.position:case PATH_PROPERTIES.scale:default:TypedKeyframeTrack=threePlatformize.VectorKeyframeTrack;break}var targetName=node.name?node.name:node.uuid;var interpolation=sampler.interpolation!==undefined?INTERPOLATION[sampler.interpolation]:threePlatformize.InterpolateLinear;var targetNames=[];if(PATH_PROPERTIES[target.path]===PATH_PROPERTIES.weights){node.traverse((function(object){if(object.isMesh===true&&object.morphTargetInfluences){targetNames.push(object.name?object.name:object.uuid)}}))}else{targetNames.push(targetName)}var outputArray=outputAccessor.array;if(outputAccessor.normalized){var scale;if(outputArray.constructor===Int8Array){scale=1/127}else if(outputArray.constructor===Uint8Array){scale=1/255}else if(outputArray.constructor==Int16Array){scale=1/32767}else if(outputArray.constructor===Uint16Array){scale=1/65535}else{throw new Error("THREE.GLTFLoader: Unsupported output accessor component type.")}var scaled=new Float32Array(outputArray.length);for(var j=0,jl=outputArray.length;j<jl;j++){scaled[j]=outputArray[j]*scale}outputArray=scaled}for(var j=0,jl=targetNames.length;j<jl;j++){var track=new TypedKeyframeTrack(targetNames[j]+"."+PATH_PROPERTIES[target.path],inputAccessor.array,outputArray,interpolation);if(sampler.interpolation==="CUBICSPLINE"){track.createInterpolant=function InterpolantFactoryMethodGLTFCubicSpline(result){return new GLTFCubicSplineInterpolant(this.times,this.values,this.getValueSize()/3,result)};track.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=true}tracks.push(track)}}var name=animationDef.name?animationDef.name:"animation_"+animationIndex;return new threePlatformize.AnimationClip(name,undefined,tracks)}))};GLTFParser.prototype.loadNode=function(nodeIndex){var json=this.json;var extensions=this.extensions;var parser=this;var nodeDef=json.nodes[nodeIndex];var nodeName=nodeDef.name?parser.createUniqueName(nodeDef.name):"";return function(){var pending=[];if(nodeDef.mesh!==undefined){pending.push(parser.getDependency("mesh",nodeDef.mesh).then((function(mesh){var node=parser._getNodeRef(parser.meshCache,nodeDef.mesh,mesh);if(nodeDef.weights!==undefined){node.traverse((function(o){if(!o.isMesh)return;for(var i=0,il=nodeDef.weights.length;i<il;i++){o.morphTargetInfluences[i]=nodeDef.weights[i]}}))}return node})))}if(nodeDef.camera!==undefined){pending.push(parser.getDependency("camera",nodeDef.camera).then((function(camera){return parser._getNodeRef(parser.cameraCache,nodeDef.camera,camera)})))}parser._invokeAll((function(ext){return ext.createNodeAttachment&&ext.createNodeAttachment(nodeIndex)})).forEach((function(promise){pending.push(promise)}));return Promise.all(pending)}().then((function(objects){var node;if(nodeDef.isBone===true){node=new threePlatformize.Bone}else if(objects.length>1){node=new threePlatformize.Group}else if(objects.length===1){node=objects[0]}else{node=new threePlatformize.Object3D}if(node!==objects[0]){for(var i=0,il=objects.length;i<il;i++){node.add(objects[i])}}if(nodeDef.name){node.userData.name=nodeDef.name;node.name=nodeName}assignExtrasToUserData(node,nodeDef);if(nodeDef.extensions)addUnknownExtensionsToUserData(extensions,node,nodeDef);if(nodeDef.matrix!==undefined){var matrix=new threePlatformize.Matrix4;matrix.fromArray(nodeDef.matrix);node.applyMatrix4(matrix)}else{if(nodeDef.translation!==undefined){node.position.fromArray(nodeDef.translation)}if(nodeDef.rotation!==undefined){node.quaternion.fromArray(nodeDef.rotation)}if(nodeDef.scale!==undefined){node.scale.fromArray(nodeDef.scale)}}parser.associations.set(node,{type:"nodes",index:nodeIndex});return node}))};GLTFParser.prototype.loadScene=function(){function buildNodeHierachy(nodeId,parentObject,json,parser){var nodeDef=json.nodes[nodeId];return parser.getDependency("node",nodeId).then((function(node){if(nodeDef.skin===undefined)return node;var skinEntry;return parser.getDependency("skin",nodeDef.skin).then((function(skin){skinEntry=skin;var pendingJoints=[];for(var i=0,il=skinEntry.joints.length;i<il;i++){pendingJoints.push(parser.getDependency("node",skinEntry.joints[i]))}return Promise.all(pendingJoints)})).then((function(jointNodes){node.traverse((function(mesh){if(!mesh.isMesh)return;var bones=[];var boneInverses=[];for(var j=0,jl=jointNodes.length;j<jl;j++){var jointNode=jointNodes[j];if(jointNode){bones.push(jointNode);var mat=new threePlatformize.Matrix4;if(skinEntry.inverseBindMatrices!==undefined){mat.fromArray(skinEntry.inverseBindMatrices.array,j*16)}boneInverses.push(mat)}else{console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',skinEntry.joints[j])}}mesh.bind(new threePlatformize.Skeleton(bones,boneInverses),mesh.matrixWorld)}));return node}))})).then((function(node){parentObject.add(node);var pending=[];if(nodeDef.children){var children=nodeDef.children;for(var i=0,il=children.length;i<il;i++){var child=children[i];pending.push(buildNodeHierachy(child,node,json,parser))}}return Promise.all(pending)}))}return function loadScene(sceneIndex){var json=this.json;var extensions=this.extensions;var sceneDef=this.json.scenes[sceneIndex];var parser=this;var scene=new threePlatformize.Group;if(sceneDef.name)scene.name=parser.createUniqueName(sceneDef.name);assignExtrasToUserData(scene,sceneDef);if(sceneDef.extensions)addUnknownExtensionsToUserData(extensions,scene,sceneDef);var nodeIds=sceneDef.nodes||[];var pending=[];for(var i=0,il=nodeIds.length;i<il;i++){pending.push(buildNodeHierachy(nodeIds[i],scene,json,parser))}return Promise.all(pending).then((function(){return scene}))}}();return GLTFLoader}();var OrbitControls=function(object,domElement){if(domElement===undefined)console.warn('THREE.OrbitControls: The second parameter "domElement" is now mandatory.');if(domElement===threePlatformize.$document)console.error('THREE.OrbitControls: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.');this.object=object;this.domElement=domElement;this.enabled=true;this.target=new threePlatformize.Vector3;this.minDistance=0;this.maxDistance=Infinity;this.minZoom=0;this.maxZoom=Infinity;this.minPolarAngle=0;this.maxPolarAngle=Math.PI;this.minAzimuthAngle=-Infinity;this.maxAzimuthAngle=Infinity;this.enableDamping=false;this.dampingFactor=.05;this.enableZoom=true;this.zoomSpeed=1;this.enableRotate=true;this.rotateSpeed=1;this.enablePan=true;this.panSpeed=1;this.screenSpacePanning=true;this.keyPanSpeed=7;this.autoRotate=false;this.autoRotateSpeed=2;this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"};this.mouseButtons={LEFT:threePlatformize.MOUSE.ROTATE,MIDDLE:threePlatformize.MOUSE.DOLLY,RIGHT:threePlatformize.MOUSE.PAN};this.touches={ONE:threePlatformize.TOUCH.ROTATE,TWO:threePlatformize.TOUCH.DOLLY_PAN};this.target0=this.target.clone();this.position0=this.object.position.clone();this.zoom0=this.object.zoom;this._domElementKeyEvents=null;this.getPolarAngle=function(){return spherical.phi};this.getAzimuthalAngle=function(){return spherical.theta};this.listenToKeyEvents=function(domElement){domElement.addEventListener("keydown",onKeyDown);this._domElementKeyEvents=domElement};this.saveState=function(){scope.target0.copy(scope.target);scope.position0.copy(scope.object.position);scope.zoom0=scope.object.zoom};this.reset=function(){scope.target.copy(scope.target0);scope.object.position.copy(scope.position0);scope.object.zoom=scope.zoom0;scope.object.updateProjectionMatrix();scope.dispatchEvent(changeEvent);scope.update();state=STATE.NONE};this.update=function(){var offset=new threePlatformize.Vector3;var quat=(new threePlatformize.Quaternion).setFromUnitVectors(object.up,new threePlatformize.Vector3(0,1,0));var quatInverse=quat.clone().invert();var lastPosition=new threePlatformize.Vector3;var lastQuaternion=new threePlatformize.Quaternion;var twoPI=2*Math.PI;return function update(){var position=scope.object.position;offset.copy(position).sub(scope.target);offset.applyQuaternion(quat);spherical.setFromVector3(offset);if(scope.autoRotate&&state===STATE.NONE){rotateLeft(getAutoRotationAngle())}if(scope.enableDamping){spherical.theta+=sphericalDelta.theta*scope.dampingFactor;spherical.phi+=sphericalDelta.phi*scope.dampingFactor}else{spherical.theta+=sphericalDelta.theta;spherical.phi+=sphericalDelta.phi}var min=scope.minAzimuthAngle;var max=scope.maxAzimuthAngle;if(isFinite(min)&&isFinite(max)){if(min<-Math.PI)min+=twoPI;else if(min>Math.PI)min-=twoPI;if(max<-Math.PI)max+=twoPI;else if(max>Math.PI)max-=twoPI;if(min<=max){spherical.theta=Math.max(min,Math.min(max,spherical.theta))}else{spherical.theta=spherical.theta>(min+max)/2?Math.max(min,spherical.theta):Math.min(max,spherical.theta)}}spherical.phi=Math.max(scope.minPolarAngle,Math.min(scope.maxPolarAngle,spherical.phi));spherical.makeSafe();spherical.radius*=scale;spherical.radius=Math.max(scope.minDistance,Math.min(scope.maxDistance,spherical.radius));if(scope.enableDamping===true){scope.target.addScaledVector(panOffset,scope.dampingFactor)}else{scope.target.add(panOffset)}offset.setFromSpherical(spherical);offset.applyQuaternion(quatInverse);position.copy(scope.target).add(offset);scope.object.lookAt(scope.target);if(scope.enableDamping===true){sphericalDelta.theta*=1-scope.dampingFactor;sphericalDelta.phi*=1-scope.dampingFactor;panOffset.multiplyScalar(1-scope.dampingFactor)}else{sphericalDelta.set(0,0,0);panOffset.set(0,0,0)}scale=1;if(zoomChanged||lastPosition.distanceToSquared(scope.object.position)>EPS||8*(1-lastQuaternion.dot(scope.object.quaternion))>EPS){scope.dispatchEvent(changeEvent);lastPosition.copy(scope.object.position);lastQuaternion.copy(scope.object.quaternion);zoomChanged=false;return true}return false}}();this.dispose=function(){scope.domElement.removeEventListener("contextmenu",onContextMenu);scope.domElement.removeEventListener("pointerdown",onPointerDown);scope.domElement.removeEventListener("wheel",onMouseWheel);scope.domElement.removeEventListener("touchstart",onTouchStart);scope.domElement.removeEventListener("touchend",onTouchEnd);scope.domElement.removeEventListener("touchmove",onTouchMove);scope.domElement.ownerDocument.removeEventListener("pointermove",onPointerMove);scope.domElement.ownerDocument.removeEventListener("pointerup",onPointerUp);if(scope._domElementKeyEvents!==null){scope._domElementKeyEvents.removeEventListener("keydown",onKeyDown)}};var scope=this;var changeEvent={type:"change"};var startEvent={type:"start"};var endEvent={type:"end"};var STATE={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};var state=STATE.NONE;var EPS=1e-6;var spherical=new threePlatformize.Spherical;var sphericalDelta=new threePlatformize.Spherical;var scale=1;var panOffset=new threePlatformize.Vector3;var zoomChanged=false;var rotateStart=new threePlatformize.Vector2;var rotateEnd=new threePlatformize.Vector2;var rotateDelta=new threePlatformize.Vector2;var panStart=new threePlatformize.Vector2;var panEnd=new threePlatformize.Vector2;var panDelta=new threePlatformize.Vector2;var dollyStart=new threePlatformize.Vector2;var dollyEnd=new threePlatformize.Vector2;var dollyDelta=new threePlatformize.Vector2;function getAutoRotationAngle(){return 2*Math.PI/60/60*scope.autoRotateSpeed}function getZoomScale(){return Math.pow(.95,scope.zoomSpeed)}function rotateLeft(angle){sphericalDelta.theta-=angle}function rotateUp(angle){sphericalDelta.phi-=angle}var panLeft=function(){var v=new threePlatformize.Vector3;return function panLeft(distance,objectMatrix){v.setFromMatrixColumn(objectMatrix,0);v.multiplyScalar(-distance);panOffset.add(v)}}();var panUp=function(){var v=new threePlatformize.Vector3;return function panUp(distance,objectMatrix){if(scope.screenSpacePanning===true){v.setFromMatrixColumn(objectMatrix,1)}else{v.setFromMatrixColumn(objectMatrix,0);v.crossVectors(scope.object.up,v)}v.multiplyScalar(distance);panOffset.add(v)}}();var pan=function(){var offset=new threePlatformize.Vector3;return function pan(deltaX,deltaY){var element=scope.domElement;if(scope.object.isPerspectiveCamera){var position=scope.object.position;offset.copy(position).sub(scope.target);var targetDistance=offset.length();targetDistance*=Math.tan(scope.object.fov/2*Math.PI/180);panLeft(2*deltaX*targetDistance/element.clientHeight,scope.object.matrix);panUp(2*deltaY*targetDistance/element.clientHeight,scope.object.matrix)}else if(scope.object.isOrthographicCamera){panLeft(deltaX*(scope.object.right-scope.object.left)/scope.object.zoom/element.clientWidth,scope.object.matrix);panUp(deltaY*(scope.object.top-scope.object.bottom)/scope.object.zoom/element.clientHeight,scope.object.matrix)}else{console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled.");scope.enablePan=false}}}();function dollyOut(dollyScale){if(scope.object.isPerspectiveCamera){scale/=dollyScale}else if(scope.object.isOrthographicCamera){scope.object.zoom=Math.max(scope.minZoom,Math.min(scope.maxZoom,scope.object.zoom*dollyScale));scope.object.updateProjectionMatrix();zoomChanged=true}else{console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled.");scope.enableZoom=false}}function dollyIn(dollyScale){if(scope.object.isPerspectiveCamera){scale*=dollyScale}else if(scope.object.isOrthographicCamera){scope.object.zoom=Math.max(scope.minZoom,Math.min(scope.maxZoom,scope.object.zoom/dollyScale));scope.object.updateProjectionMatrix();zoomChanged=true}else{console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled.");scope.enableZoom=false}}function handleMouseDownRotate(event){rotateStart.set(event.clientX,event.clientY)}function handleMouseDownDolly(event){dollyStart.set(event.clientX,event.clientY)}function handleMouseDownPan(event){panStart.set(event.clientX,event.clientY)}function handleMouseMoveRotate(event){rotateEnd.set(event.clientX,event.clientY);rotateDelta.subVectors(rotateEnd,rotateStart).multiplyScalar(scope.rotateSpeed);var element=scope.domElement;rotateLeft(2*Math.PI*rotateDelta.x/element.clientHeight);rotateUp(2*Math.PI*rotateDelta.y/element.clientHeight);rotateStart.copy(rotateEnd);scope.update()}function handleMouseMoveDolly(event){dollyEnd.set(event.clientX,event.clientY);dollyDelta.subVectors(dollyEnd,dollyStart);if(dollyDelta.y>0){dollyOut(getZoomScale())}else if(dollyDelta.y<0){dollyIn(getZoomScale())}dollyStart.copy(dollyEnd);scope.update()}function handleMouseMovePan(event){panEnd.set(event.clientX,event.clientY);panDelta.subVectors(panEnd,panStart).multiplyScalar(scope.panSpeed);pan(panDelta.x,panDelta.y);panStart.copy(panEnd);scope.update()}function handleMouseWheel(event){if(event.deltaY<0){dollyIn(getZoomScale())}else if(event.deltaY>0){dollyOut(getZoomScale())}scope.update()}function handleKeyDown(event){var needsUpdate=false;switch(event.code){case scope.keys.UP:pan(0,scope.keyPanSpeed);needsUpdate=true;break;case scope.keys.BOTTOM:pan(0,-scope.keyPanSpeed);needsUpdate=true;break;case scope.keys.LEFT:pan(scope.keyPanSpeed,0);needsUpdate=true;break;case scope.keys.RIGHT:pan(-scope.keyPanSpeed,0);needsUpdate=true;break}if(needsUpdate){event.preventDefault();scope.update()}}function handleTouchStartRotate(event){if(event.touches.length==1){rotateStart.set(event.touches[0].pageX,event.touches[0].pageY)}else{var x=.5*(event.touches[0].pageX+event.touches[1].pageX);var y=.5*(event.touches[0].pageY+event.touches[1].pageY);rotateStart.set(x,y)}}function handleTouchStartPan(event){if(event.touches.length==1){panStart.set(event.touches[0].pageX,event.touches[0].pageY)}else{var x=.5*(event.touches[0].pageX+event.touches[1].pageX);var y=.5*(event.touches[0].pageY+event.touches[1].pageY);panStart.set(x,y)}}function handleTouchStartDolly(event){var dx=event.touches[0].pageX-event.touches[1].pageX;var dy=event.touches[0].pageY-event.touches[1].pageY;var distance=Math.sqrt(dx*dx+dy*dy);dollyStart.set(0,distance)}function handleTouchStartDollyPan(event){if(scope.enableZoom)handleTouchStartDolly(event);if(scope.enablePan)handleTouchStartPan(event)}function handleTouchStartDollyRotate(event){if(scope.enableZoom)handleTouchStartDolly(event);if(scope.enableRotate)handleTouchStartRotate(event)}function handleTouchMoveRotate(event){if(event.touches.length==1){rotateEnd.set(event.touches[0].pageX,event.touches[0].pageY)}else{var x=.5*(event.touches[0].pageX+event.touches[1].pageX);var y=.5*(event.touches[0].pageY+event.touches[1].pageY);rotateEnd.set(x,y)}rotateDelta.subVectors(rotateEnd,rotateStart).multiplyScalar(scope.rotateSpeed);var element=scope.domElement;rotateLeft(2*Math.PI*rotateDelta.x/element.clientHeight);rotateUp(2*Math.PI*rotateDelta.y/element.clientHeight);rotateStart.copy(rotateEnd)}function handleTouchMovePan(event){if(event.touches.length==1){panEnd.set(event.touches[0].pageX,event.touches[0].pageY)}else{var x=.5*(event.touches[0].pageX+event.touches[1].pageX);var y=.5*(event.touches[0].pageY+event.touches[1].pageY);panEnd.set(x,y)}panDelta.subVectors(panEnd,panStart).multiplyScalar(scope.panSpeed);pan(panDelta.x,panDelta.y);panStart.copy(panEnd)}function handleTouchMoveDolly(event){var dx=event.touches[0].pageX-event.touches[1].pageX;var dy=event.touches[0].pageY-event.touches[1].pageY;var distance=Math.sqrt(dx*dx+dy*dy);dollyEnd.set(0,distance);dollyDelta.set(0,Math.pow(dollyEnd.y/dollyStart.y,scope.zoomSpeed));dollyOut(dollyDelta.y);dollyStart.copy(dollyEnd)}function handleTouchMoveDollyPan(event){if(scope.enableZoom)handleTouchMoveDolly(event);if(scope.enablePan)handleTouchMovePan(event)}function handleTouchMoveDollyRotate(event){if(scope.enableZoom)handleTouchMoveDolly(event);if(scope.enableRotate)handleTouchMoveRotate(event)}function onPointerDown(event){if(scope.enabled===false)return;switch(event.pointerType){case"mouse":case"pen":onMouseDown(event);break}}function onPointerMove(event){if(scope.enabled===false)return;switch(event.pointerType){case"mouse":case"pen":onMouseMove(event);break}}function onPointerUp(event){switch(event.pointerType){case"mouse":case"pen":onMouseUp();break}}function onMouseDown(event){event.preventDefault();scope.domElement.focus?scope.domElement.focus():threePlatformize.$window.focus();var mouseAction;switch(event.button){case 0:mouseAction=scope.mouseButtons.LEFT;break;case 1:mouseAction=scope.mouseButtons.MIDDLE;break;case 2:mouseAction=scope.mouseButtons.RIGHT;break;default:mouseAction=-1}switch(mouseAction){case threePlatformize.MOUSE.DOLLY:if(scope.enableZoom===false)return;handleMouseDownDolly(event);state=STATE.DOLLY;break;case threePlatformize.MOUSE.ROTATE:if(event.ctrlKey||event.metaKey||event.shiftKey){if(scope.enablePan===false)return;handleMouseDownPan(event);state=STATE.PAN}else{if(scope.enableRotate===false)return;handleMouseDownRotate(event);state=STATE.ROTATE}break;case threePlatformize.MOUSE.PAN:if(event.ctrlKey||event.metaKey||event.shiftKey){if(scope.enableRotate===false)return;handleMouseDownRotate(event);state=STATE.ROTATE}else{if(scope.enablePan===false)return;handleMouseDownPan(event);state=STATE.PAN}break;default:state=STATE.NONE}if(state!==STATE.NONE){scope.domElement.ownerDocument.addEventListener("pointermove",onPointerMove);scope.domElement.ownerDocument.addEventListener("pointerup",onPointerUp);scope.dispatchEvent(startEvent)}}function onMouseMove(event){if(scope.enabled===false)return;event.preventDefault();switch(state){case STATE.ROTATE:if(scope.enableRotate===false)return;handleMouseMoveRotate(event);break;case STATE.DOLLY:if(scope.enableZoom===false)return;handleMouseMoveDolly(event);break;case STATE.PAN:if(scope.enablePan===false)return;handleMouseMovePan(event);break}}function onMouseUp(event){scope.domElement.ownerDocument.removeEventListener("pointermove",onPointerMove);scope.domElement.ownerDocument.removeEventListener("pointerup",onPointerUp);if(scope.enabled===false)return;scope.dispatchEvent(endEvent);state=STATE.NONE}function onMouseWheel(event){if(scope.enabled===false||scope.enableZoom===false||state!==STATE.NONE&&state!==STATE.ROTATE)return;event.preventDefault();scope.dispatchEvent(startEvent);handleMouseWheel(event);scope.dispatchEvent(endEvent)}function onKeyDown(event){if(scope.enabled===false||scope.enablePan===false)return;handleKeyDown(event)}function onTouchStart(event){if(scope.enabled===false)return;event.preventDefault();switch(event.touches.length){case 1:switch(scope.touches.ONE){case threePlatformize.TOUCH.ROTATE:if(scope.enableRotate===false)return;handleTouchStartRotate(event);state=STATE.TOUCH_ROTATE;break;case threePlatformize.TOUCH.PAN:if(scope.enablePan===false)return;handleTouchStartPan(event);state=STATE.TOUCH_PAN;break;default:state=STATE.NONE}break;case 2:switch(scope.touches.TWO){case threePlatformize.TOUCH.DOLLY_PAN:if(scope.enableZoom===false&&scope.enablePan===false)return;handleTouchStartDollyPan(event);state=STATE.TOUCH_DOLLY_PAN;break;case threePlatformize.TOUCH.DOLLY_ROTATE:if(scope.enableZoom===false&&scope.enableRotate===false)return;handleTouchStartDollyRotate(event);state=STATE.TOUCH_DOLLY_ROTATE;break;default:state=STATE.NONE}break;default:state=STATE.NONE}if(state!==STATE.NONE){scope.dispatchEvent(startEvent)}}function onTouchMove(event){if(scope.enabled===false)return;event.preventDefault();switch(state){case STATE.TOUCH_ROTATE:if(scope.enableRotate===false)return;handleTouchMoveRotate(event);scope.update();break;case STATE.TOUCH_PAN:if(scope.enablePan===false)return;handleTouchMovePan(event);scope.update();break;case STATE.TOUCH_DOLLY_PAN:if(scope.enableZoom===false&&scope.enablePan===false)return;handleTouchMoveDollyPan(event);scope.update();break;case STATE.TOUCH_DOLLY_ROTATE:if(scope.enableZoom===false&&scope.enableRotate===false)return;handleTouchMoveDollyRotate(event);scope.update();break;default:state=STATE.NONE}}function onTouchEnd(event){if(scope.enabled===false)return;scope.dispatchEvent(endEvent);state=STATE.NONE}function onContextMenu(event){if(scope.enabled===false)return;event.preventDefault()}scope.domElement.addEventListener("contextmenu",onContextMenu);scope.domElement.addEventListener("pointerdown",onPointerDown);scope.domElement.addEventListener("wheel",onMouseWheel);scope.domElement.addEventListener("touchstart",onTouchStart);scope.domElement.addEventListener("touchend",onTouchEnd);scope.domElement.addEventListener("touchmove",onTouchMove);this.update()};OrbitControls.prototype=Object.create(threePlatformize.EventDispatcher.prototype);OrbitControls.prototype.constructor=OrbitControls;var MapControls=function(object,domElement){OrbitControls.call(this,object,domElement);this.screenSpacePanning=false;this.mouseButtons.LEFT=threePlatformize.MOUSE.PAN;this.mouseButtons.RIGHT=threePlatformize.MOUSE.ROTATE;this.touches.ONE=threePlatformize.TOUCH.PAN;this.touches.TWO=threePlatformize.TOUCH.DOLLY_ROTATE};MapControls.prototype=Object.create(threePlatformize.EventDispatcher.prototype);MapControls.prototype.constructor=MapControls;Page({disposing:false,platform:null,frameId:-1,onReady(){console.log("ready");tt.createSelectorQuery().select("#gl").node().exec((async res=>{const canvas=res[0].node;console.log("init scene");this.platform=new BytePlatform(canvas);threePlatformize.PLATFORM.set(this.platform);const renderer=new threePlatformize.WebGL1Renderer({canvas:canvas,antialias:true,alpha:true});const camera=new threePlatformize.PerspectiveCamera(75,canvas.width/canvas.height,.1,1e3);const scene=new threePlatformize.Scene;const gltfLoader=new GLTFLoader;const textureLoader=new threePlatformize.TextureLoader;const controls=new OrbitControls(camera,canvas);controls.enableDamping=true;console.log(canvas.width,canvas.height,threePlatformize.$window.devicePixelRatio);console.log("load gltf");{const geometry=new threePlatformize.PlaneGeometry(1,1);const material=new threePlatformize.MeshBasicMaterial({color:1193046});const mesh=new threePlatformize.Mesh(geometry,material);scene.add(mesh)}{const geometry=new threePlatformize.PlaneGeometry(1,1);const material=new threePlatformize.MeshBasicMaterial({map:textureLoader.load("https://cdn.static.oppenlab.com/weblf/test/open%20mouth.jpg",(()=>{console.log("texture loaded")}),undefined,(e=>console.log("texture load error",e)))});const mesh=new threePlatformize.Mesh(geometry,material);mesh.position.y=1;scene.add(mesh)}scene.background=new threePlatformize.Color(6636321);camera.position.z=5;renderer.setSize(canvas.width,canvas.height,false);const render=()=>{if(!this.disposing)this.frameId=threePlatformize.$requestAnimationFrame(render);controls.update();renderer.render(scene,camera)};render()}))},onUnload(){this.disposing=true;threePlatformize.$cancelAnimationFrame(this.frameId);threePlatformize.PLATFORM.dispose()},onTX(e){this.platform.dispatchTouchEvent(e)}});
